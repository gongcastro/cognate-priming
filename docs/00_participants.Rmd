---
title: "Participants"
output: github_document
always_allow_html: true
date: "`r paste0('Updated: ', format(Sys.Date(), '%d/%m/%Y'))`"
---



```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = FALSE,
	message = TRUE,
	warning = TRUE, 
	cache.extra = knitr::rand_seed,
	out.width = "80%",
	results = "asis",
	dpi = 300,
	dev.args = list(png = list(type = "cairo"))
)

options(
	knitr.kable.NA = '-',
	knitr.duplicate.label = "allow",
	ggplot2.discrete.fill = pal_d3()(4),
	ggplot2.discrete.colour = pal_d3()(4)
)


```


```{r params, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}

# load objects
tar_load_globals()
tar_load(participants)
tar_load(vocabulary)
tar_load(attrition)

theme_set(theme_minimal()) # in utils.R
```


```{r prepare, message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE}

attrition <- attrition %>% 
	mutate(
		valid_gaze = valid_gaze_prime & valid_gaze_target,
		valid_status = case_when(
			!valid_gaze ~ "Invalid gaze",
			!valid_participant ~ "Invalid participant",
			TRUE ~ "Valid"
		))


participants <- participants %>% 
	left_join(distinct(attrition, participant, age_group, valid_participant)) %>% 
	drop_na(participant) %>% 
	left_join(vocabulary) %>% 
	mutate(vocab_size_l1_center = scale(vocab_size_l1)[,1])



```



* We collected data from `r length(unique(participants$participant))` participants `r length(unique(participants$participant[participants$location=="Oxford"]))` were tested in Oxford, and `r length(unique(participants$participant[participants$location=="Barcelona"]))` were tested in Barcelona.
* After applying trial- ad participant-level exclusion criteria, the sample comprise data from `r length(unique(participants$participant[participants$valid_participant]))` (`r length(unique(participants$participant[participants$valid_participant & participants$location=="Oxford"]))` tested in Oxford, and `r length(unique(participants$participant[participants$valid_participant & participants$location=="Barcelona"]))` tested in Barcelona), and were included in our analyses.
* `r length(participants$participant[duplicated(participants$participant) & participants$valid_participant])` participants in the final sample were longitudinal (tested in at least one age group). `r length(participants$participant[duplicated(participants$participant) & participants$location=="Oxford" & participants$valid_participant])` longitudinal participants were tested in Oxford and `r length(participants$participant[duplicated(participants$participant) & participants$location=="Barcelona" & participants$valid_participant])` were tested in Barcelona.
* From the longitudinal participants, `r length(participants$participant[(as.data.frame(table(participants$participant))$Freq>2) & participants$valid_participant])` were tested at two age groups, and `r length(participants$participant[(as.data.frame(table(participants$participant))$Freq>2) & participants$valid_participant])`were tested at three age groups.


# Summary

```{r participants_summary_tab, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE, fig.height=4, out.width="100%"}
participants_tab <- participants %>% 
	left_join(distinct(attrition, participant, valid_participant)) %>% 
	drop_na(valid_participant) %>% 
	count(age_group, lp, valid_participant) %>% 
	pivot_wider(
		names_from = c("age_group", "valid_participant"),
		values_from = c("n"), 
		values_fill = 0
	) %>% 
	mutate(
		`21 months` = paste0(`21 months_TRUE`, " (", `21 months_FALSE`, ")"),
		`25 months` = paste0(`25 months_TRUE`, " (", `25 months_FALSE`, ")"),
		`30 months` = paste0(`30 months_TRUE`, " (", `30 months_FALSE`, ")")
		
	) %>% 
	select(-c(ends_with("TRUE"), ends_with("FALSE"))) %>% 
	gt() %>% 
	tab_header(
		title = "Testing sessions",
		subtitle = "Invalid testing sessions are shown between parentheses"
	) %>%
	cols_label(
		lp = "",
		`21 months` = md("**21 months**"),
		`25 months` = md("**25 months**"),
		`30 months` = md("**30 months**")
	) %>% 
	tab_style(
		style = list(
			cell_text(weight = "bold"),
			cell_fill("grey82")
		),
		locations = list(
			cells_row_groups()
		)
	)

gtsave(participants_tab, here("img", "participants_tab.png"))
as_raw_html(participants_tab)
```

```{r participants_summary_tab_language, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE, fig.height=4, out.width="100%"}
participants_tab <- participants %>% 
	left_join(distinct(attrition, participant, valid_participant)) %>% 
	drop_na(valid_participant) %>% 
	count(age_group, lp, test_language, valid_participant) %>% 
	pivot_wider(
		names_from = c("age_group", "valid_participant"),
		values_from = c("n"), 
		values_fill = 0
	) %>% 
	mutate(
		`21 months` = paste0(`21 months_TRUE`, " (", `21 months_FALSE`, ")"),
		`25 months` = paste0(`25 months_TRUE`, " (", `25 months_FALSE`, ")"),
		`30 months` = paste0(`30 months_TRUE`, " (", `30 months_FALSE`, ")")
		
	) %>% 
	select(-c(ends_with("TRUE"), ends_with("FALSE"))) %>% 
	gt(groupname_col = "lp") %>% 
	cols_label(
		lp = md("**Language profile**"),
		test_language = "",
		`21 months` = md("**21 months**"),
		`25 months` = md("**25 months**"),
		`30 months` = md("**30 months**")
	) %>% 
	tab_style(
		style = list(
			cell_text(weight = "bold"),
			cell_fill("grey82")
		),
		locations = list(
			cells_row_groups()
		)
	)

gtsave(participants_tab, here("img", "participants_tab.png"))
as_raw_html(participants_tab)
```


```{r participants_summary_plot, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE, fig.height=4, out.width="100%"}
participants %>% 
	left_join(distinct(attrition, participant, valid_participant)) %>% 
	filter(valid_participant) %>% 
	drop_na(valid_participant) %>% 
	ggplot(aes(lp, fill = as.factor(lp))) +
	facet_grid(~age_group, scales = "free") +
	geom_bar(colour = NA) +
	geom_hline(yintercept = 24, linetype = "dashed", colour = "black") +
	labs(x = "Group", y = "Sample size", fill = "Test language") +
	theme(
		legend.position = "none",
		axis.title.x = element_blank(),
		axis.text = element_text(size = 10),
		axis.title.y = element_text(angle = 90),
		panel.grid.major.x = element_blank()
	) 
```


# Longitudinal

We collected data from `r sum(duplicated(participants$participant))` longitudinal participants, that is, who were tested in at least two of the three ages (21, 25, and 30). Of those, `r sum(duplicated(participants$participant[participants$location=="Oxford"]))` were tested in Oxford, and `r sum(duplicated(participants$participant[participants$location=="Barcelona"]))` were tested in Barcelona.

```{r participants_cohort, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE, fig.height=4, out.width="100%"}
# plot participants
participants %>% 
	left_join(distinct(attrition, participant, valid_participant)) %>%
	filter(valid_participant) %>% 
	count(participant, age_group) %>% 
	pivot_wider(
		id_cols = participant,
		names_from = age_group,
		values_from = n,
		values_fill = 0
	) %>% 
	pivot_longer(
		2:4,
		names_to = "age_group",
		values_to = "n"
	) %>% 
	ggplot() +
	aes(
		age_group,
		participant,
		fill = as.factor(n)
	) + 
	geom_tile(
		colour = "white"
	) +
	labs(
		x = "Age (months)", 
		y = "Exposure to 2nd language", 
		fill = "Lang. Pofile"
	) +
	scale_fill_manual(values = c("white", pal_d3()(2)[2])) +
	theme(
		legend.position = "top",
		legend.title = element_blank(),
		panel.grid = element_blank(),
		axis.text = element_text(size = 10),
		axis.title.y = element_blank(),
		axis.text.y = element_text(size = 7),
		axis.ticks.y = element_blank()
	)

ggsave(
	here("img", "participants_longitudinal.png"),
	height = 15,
	width = 1.5
)

```


# Language profile

```{r participants-lp, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}

participants %>% 
	select(participant, age_group, lp, starts_with("doe_"), test_language) %>% 
	mutate(participant = paste0(participant, "(", age_group, ")")) %>% 
	pivot_longer(
		starts_with("doe_"),
		names_to = "language",
		values_to = "doe"
	) %>% 
	mutate(
		language = str_remove_all(language, "doe_") %>% 
			str_to_sentence(),
	) %>% 
	ggplot() +
	aes(
		x = doe,
		y = reorder(participant, lp),
		fill = language
	) +
	facet_wrap(
		lp~test_language,
		scales = "free_y",
		labeller = label_wrap_gen(multi_line = FALSE)
	) +
	geom_col(
		position = position_fill(),
		size = 0.1,
		colour = "white"
	) +
	geom_vline(
		xintercept = 0.5
	) +
	labs(
		x = "Degree of exposure",
		y = "Participant",
		fill = "Language"
	) +
	scale_x_continuous(
		labels = percent
	) +
	theme(
		axis.text.y = element_blank(),
		panel.grid = element_blank(),
		axis.title.y = element_blank(),
		plot.background = element_rect(fill = "white")
		
	)

ggsave(here("img", "participants_lp.png"))


```









