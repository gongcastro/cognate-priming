---
title: "Attrition"
output: github_document
always_allow_html: true
date: "`r paste0('Updated: ', format(Sys.Date(), '%d/%m/%Y'))`"
---



```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = FALSE,
	message = TRUE,
	warning = TRUE, 
	cache.extra = knitr::rand_seed,
	out.width = "80%",
	results = "asis",
	dpi = 300,
	dev.args = list(png = list(type = "cairo"))
)

options(
	knitr.kable.NA = '-',
	knitr.duplicate.label = "allow",
	ggplot2.discrete.fill = pal_d3()(4),
	ggplot2.discrete.colour = pal_d3()(4)
)


```


```{r params, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}

# load objects
tar_load_globals()
tar_load(participants)
tar_load(vocabulary)
tar_load(stimuli)
tar_load(attrition)

theme_set(theme_custom()) # in utils.R

attrition <- attrition %>% 
	mutate(
		valid_gaze = valid_gaze_prime & valid_gaze_target,
		valid_status = case_when(
			!valid_gaze ~ "Invalid gaze",
			!valid_participant ~ "Invalid participant",
			TRUE ~ "Valid"
		))
```


# Summary

```{r participants_cdi, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE, fig.height=4, out.width="100%"}
# plot participants
participants %>% 
	left_join(distinct(attrition, participant, valid_participant)) %>%
	left_join(vocabulary) %>% 
	drop_na(valid_participant) %>% 
	mutate(
		valid_status = case_when(
			valid_participant & !is.na(vocab_size_l1) ~ "Valid (+ CDI)",
			valid_participant & is.na(vocab_size_l1) ~ "Valid (no CDI)",
			!valid_participant ~ "Not valid"
		)
	) %>% 
	ggplot() +
	aes(lp, fill = valid_status) +
	facet_grid(~age_group, scales = "free") +
	geom_bar(size = 1) +
	geom_hline(
		yintercept = 24,
		linetype = "dashed",
		colour = "white"
	) +
	scale_colour_brewer(palette = "Set1") +
	labs(x = "Group", y = "Sample size", fill = "Valid?") +
	theme(
		legend.position = "top",
		legend.title = element_blank(),
		panel.grid.major.x = element_blank(),
		panel.grid.minor.y = element_blank(),
		axis.title.x = element_blank(),
		axis.text = element_text(size = 10),
		axis.title.y = element_text(angle = 90)
	) 

ggsave(here("img", "participant_attrition.png"))
```


# By location

```{r trials_attrition_location, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE, fig.height=8, out.width="100%"}
# plot participants
attrition_location <- attrition %>% 
	left_join(select(participants, participant, lp)) %>% 
	count(lp, age_group, trial_type, valid_status) %>% 
	drop_na(trial_type)

attrition_location %>% 
	ggplot() +
	aes(
		trial_type, 
		n,
		fill = valid_status, 
		colour = valid_status
	) +
	facet_grid(lp~age_group) +
	geom_col(
		position = position_fill(), 
		colour = "white"
	) +
	labs(
		x = "Trial type", 
		y = "Trials",
		colour = "Validity", 
		fill = "Validity"
	) +
	scale_y_continuous(labels = percent) +
	theme(
		legend.position = "top",
		axis.title.x = element_blank()
	)

ggsave(here("img", "attrition_participants.png"))

```


# By group

This table shows a summary of the total, total valid, and proportion of valid monolingual and bilingual participants tested in each lab (Barcelona and Oxford), in each age group (21, 25, and 30 months), and the mean of valid trials they contributed in each trial type (cognate, non-cognate, and unrelated). 


```{r attrition, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE, fig.height=12}

attrition %>% 
	left_join(select(participants, age_group, lp, participant, date_test)) %>% 
	group_by(participant, lp, trial_type, date_test, age_group, valid_participant) %>% 
	summarise(
		valid_trial_count = sum(valid_trial, na.rm = TRUE),
		.groups = "drop"
	) %>% 
	pivot_wider(
		names_from = trial_type,
		values_from = valid_trial_count
	) %>% 
	clean_names() %>% 
	group_by(lp, age_group) %>% 
	summarise(
		cognate = mean(cognate, na.rm = TRUE),
		non_cognate = mean(non_cognate, na.rm = TRUE),
		unrelated = mean(unrelated, na.rm = TRUE),
		sum_n = sum(valid_participant, na.rm = TRUE),
		prop_n = mean(valid_participant, na.rm = TRUE),
		n = n(),
		.groups = "drop"
	) %>% 
	arrange(age_group, lp) %>% 
	relocate(age_group, lp, cognate, non_cognate, unrelated, sum_n, n, prop_n) %>% 
	gt(groupname_col = "age_group") %>% 
	tab_spanner(
		"Mean valid trials",
		c("cognate", "non_cognate", "unrelated")
	) %>% 
	tab_spanner(
		"N participants",
		c("sum_n", "n", "prop_n")
	) %>% 
	cols_label(
		age_group = "Age",
		lp = "",
		sum_n = "Valid",
		n = "Tested",
		prop_n = "Valid (%)",
		cognate = "Cognate (8)",
		non_cognate = "Non-cognate (8)",
		unrelated = "Unrelated (16)"
	) %>% 
	fmt_number(c("cognate", "non_cognate", "unrelated")) %>%
	fmt_percent(c("prop_n")) %>% 
	fmt_number(c("n", "sum_n"), decimals = 0) %>% 
	tab_style(
		style = cell_text(weight = "bold"),
		locations = list(
			cells_row_groups(),
			cells_column_spanners()
		)
	)
as_raw_html()

```


# By participant


```{r participants_attrition, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE, fig.height=4, out.width="100%"}
# plot participants
tab_participant_attrition <- attrition %>% 
	left_join(select(participants, participant, lp)) %>% 
	mutate(participant = str_remove(participant, "cognatepriming")) %>% 
	group_by(participant, lp, age_group, valid_participant) %>% 
	summarise(
		valid = mean(valid_trial),
		invalid_gaze = mean(!valid_gaze),
		.groups = "drop"
	) %>% 
	relocate(participant) %>% 
	gt(groupname_col = "participant") %>% 
	tab_spanner(label = "Invalid trials", columns = starts_with("invalid_")) %>% 
	cols_label(
		participant = "Participant",
		lp = "Group",
		age_group = "Age",
		valid_participant = "Valid participant",
		valid = "Valid trials (%)",
		invalid_gaze = "Gaze (%)"
	) %>% 
	fmt_percent(c("valid", "invalid_gaze")) %>% 
	tab_style(
		style = cell_text(weight = "bold"),
		locations = list(
			cells_column_labels()
		)
	) %>% 
	tab_style(
		style = cell_text(style = "italic"),
		locations = list(
			cells_row_groups()
		)
	) 

gtsave(tab_participant_attrition, here("img", "participants_attrition_table.png"))
as_raw_html(tab_participant_attrition)
```


# By trial


```{r trials_attrition_table, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE, fig.height=4, out.width="100%"}
# plot participants
tab_n_trials <- attrition %>% 
	left_join(select(participants, participant, lp)) %>% 
	drop_na(trial_type) %>% 
	group_by(lp, age_group, trial_type, valid_trial) %>% 
	count() %>% 
	ungroup() %>%
	mutate(
		valid_trial = ifelse(
			valid_trial,
			"Valid",
			"Not valid"
		)
	) %>% 
	pivot_wider(
		names_from = c(age_group, valid_trial), 
		values_from = n,
		values_fill = 0
	) %>% 
	clean_names() %>% 
	gt(groupname_col = "lp") %>% 
	tab_spanner(
		label = "21 months", 
		columns = contains("21_")
	) %>% 
	tab_spanner(
		label = "25 months", 
		columns = contains("25_")
	) %>% 
	tab_spanner(
		label = "30 months", 
		columns = contains("30_")
	) %>% 
	cols_label(
		lp = "Group",
		trial_type = "Trial type",
		x21_months_not_valid = "Not valid",
		x21_months_valid = "Valid",
		x25_months_not_valid = "Not valid",
		x25_months_valid = "Valid",
		x30_months_not_valid = "Not valid",
		x30_months_valid = "Valid"
	) %>% 
	tab_style(
		style = list(
			cell_text(weight = "bold")
		),
		locations = list(
			cells_column_spanners()
		)
	) %>% 
	tab_style(
		style = list(
			cell_text(style = "italic")
		),
		locations = list(
			cells_row_groups()
		)
	)

gtsave(tab_n_trials, here("img", "attrition_trials.png"))

as_raw_html(tab_n_trials)

```


```{r trials_attrition, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE, fig.height=4, out.width="100%"}
# plot participants
attrition %>% 
	left_join(select(participants, participant)) %>% 
	count(age_group, trial_type, valid_status) %>% 
	drop_na(trial_type) %>% 
	ggplot() +
	aes(
		trial_type,
		n,
		fill = valid_status, 
		colour = valid_status
	) +
	facet_grid(~age_group) +
	geom_col(position = position_fill(), colour = "white") +
	labs(x = "Trial type", y = "Trials", colour = "Validity", fill = "Validity") +
	scale_y_continuous(labels = percent) +
	guides(fill = guide_legend(ncol = 2), colour = guide_legend(ncol = 2))	+
	coord_flip() +
	theme(
		legend.position = "top",
		legend.title = element_blank(),
		panel.grid = element_blank(),
		axis.text.x = element_text(angle = 20, hjust = 1, vjust = 1, size = 10),
		axis.text.y = element_text(size = 8),
		axis.title = element_blank()
	)
```


## By lexical frequency {.tabset }


```{r attrition_frequency_target, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE, fig.height=4, out.width="100%"}
sample_size <- attrition %>% 
	left_join(distinct(participants, participant, age_group, lp)) %>% 
	left_join(distinct(stimuli, test_language, list, trial, trial_type, frequency_target_childes)) %>% 
	mutate(valid_status = ifelse(valid_status!="Valid", "Invalid", valid_status)) %>% 
	drop_na(trial_type, frequency_target_childes) %>% 
	count(trial_type, lp, age_group, valid_status)

attrition %>% 
	left_join(distinct(stimuli, test_language, list, trial, trial_type, frequency_target_childes)) %>% 
	mutate(
		valid_status = ifelse(
			valid_status != "Valid", 
			"Invalid", 
			valid_status
		)
	) %>% 
	drop_na(trial_type, frequency_target_childes) %>% 
	ggplot() +
	aes(
		trial_type,
		frequency_target_childes,
		fill = valid_status,
		colour = valid_status
	) +
	facet_grid(lp~age_group) +
	geom_boxplot(
		fill = "white", 
		width = 0.25,
		position =  position_dodge(width = 1),
		size = 0.75, 
		outlier.colour = NA
	) +
	geom_label(
		data = sample_size, 
		aes(
			y = 2,
			label = format(n, big.mark = ",", scientific = FALSE)
		), 
		size = 3,
		position = position_dodge(width = 1), 
		colour = "white"
	) +
	labs(
		x = "Trial type",
		y = "Frequency (CHILDES)", 
		colour = "Validity", 
		fill = "Validity"
	) +
	scale_y_continuous(
		breaks = 0:7, 
		limits = c(0, 7)
	) +
	theme(
		legend.position = "top",
		legend.title = element_blank(),
		panel.grid.major.y = element_line(colour = "grey", linetype = "dotted"),
		axis.text.y = element_text(size = 8),
		axis.title.x = element_blank()
	)

ggsave(here("img", "attrition_frequency_childes.png"))

```


```{r attrition_frequency_target_causes, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE, fig.height=4, out.width="100%"}
attrition %>% 
	left_join(
		distinct(
			stimuli, 
			test_language,
			list, 
			trial, 
			trial_type,
			frequency_target_childes
		)
	) %>% 
	drop_na(
		trial_type,
		frequency_target_childes
	) %>% 
	mutate(frequency_target_childes = round(frequency_target_childes)) %>% 
	count(
		trial_type,
		age_group, 
		valid_status, 
		trial_type,
		frequency_target_childes
	) %>% 
	ggplot() +
	aes(
		as.factor(frequency_target_childes),
		n, 
		fill = valid_status, 
		colour = valid_status
	) + 
	facet_grid(trial_type~age_group) +
	geom_col(
		position = position_fill(), 
		colour = "white"
	) +
	labs(
		x = "Trial type",
		y = "Trials", 
		colour = "Validity",
		fill = "Validity"
	) +
	guides(
		fill = guide_legend(ncol = 2), 
		colour = guide_legend(ncol = 2)
	)	+
	scale_y_continuous(labels = percent) +
	coord_flip() +
	theme(
		legend.position = "top",
		legend.title = element_blank(),
		panel.grid = element_blank(),
		axis.text.x = element_text(size = 10),
		axis.text.y = element_text(size = 8),
	)

ggsave(here("img", "attrition_frequency_target_childes.png"))
```



## By familiarity {.tabset}

```{r attrition_familiarity_target, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE, fig.height=4, out.width="100%"}
sample_size <- attrition %>% 
	left_join(distinct(participants, participant, age_group, lp)) %>% 
	left_join(distinct(stimuli, test_language, list, trial, trial_type, familiarity_target)) %>% 
	mutate(valid_status = ifelse(valid_status!="Valid", "Invalid", valid_status)) %>% 
	drop_na(trial_type, familiarity_target) %>% 
	count(trial_type, lp, age_group, valid_status)

attrition %>% 
	left_join(distinct(stimuli, test_language, list, trial, trial_type, familiarity_target)) %>% 
	mutate(
		valid_status = ifelse(
			valid_status!="Valid",
			"Invalid",
			valid_status
		)
	) %>% 
	drop_na(trial_type, familiarity_target) %>% 
	ggplot() +
	aes(
		trial_type,
		familiarity_target,
		fill = valid_status, 
		colour = valid_status
	) +
	facet_grid(lp~age_group) +
	geom_boxplot(
		colour = "black",
		width = 0.25,
		position = position_dodge(width = 0.9),
		size = 0.75, 
		outlier.colour = NA
	) +
	geom_label(
		data = sample_size, 
		aes(
			y = 0.1,
			label = format(n, big.mark = ",")
		),
		size = 3,
		position = position_dodge(width = 0.9),
		colour = "white"
	) +
	labs(
		x = "Trial type",
		y = "Familiarity", 
		colour = "Validity", 
		fill = "Validity"
	) +
	guides(
		fill = guide_legend(ncol = 2), 
		colour = guide_legend(ncol = 2)
	)	+
	scale_y_continuous(
		labels = percent, 
		limits = c(0, 1)
	) +
	theme(
		legend.position = "top",
		legend.title = element_blank(),
		panel.grid.major.y = element_blank(),
		axis.text.x = element_text(angle = 20, hjust = 1, vjust = 1, size = 10),
		axis.text.y = element_text(size = 8),
		axis.title = element_blank()
	)

ggsave(here("attrition_familiarity.png"))
```


```{r attrition_familiarity_target_causes, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE, fig.height=4, out.width="100%"}
# plot participants
attrition %>% 
	left_join(distinct(stimuli, test_language, list, trial, trial_type, familiarity_target)) %>% 
	drop_na(
		trial_type, 
		familiarity_target
	) %>% 
	mutate(familiarity_target = round(familiarity_target, digits = 1)) %>% 
	count(
		trial_type,
		age_group,
		valid_status, 
		trial_type, 
		familiarity_target
	) %>% 
	ggplot() +
	aes(
		as.factor(familiarity_target), 
		n, 
		fill = valid_status,
		colour = valid_status
	) +
	facet_grid(trial_type~age_group) +
	geom_col(
		position = position_fill(),
		colour = "white"
	) +
	labs(
		x = "Trial type",
		y = "Trials",
		colour = "Validity", 
		fill = "Validity"
	) +
	guides(
		fill = guide_legend(ncol = 2), 
		colour = guide_legend(ncol = 2)
	)	+
	scale_x_discrete(
		labels = function(x) paste0(as.numeric(x)*100, "%"),
	) +
	scale_y_continuous(labels = percent) +
	scale_fill_d3() +
	coord_flip() +
	theme(
		legend.position = "top",
		legend.title = element_blank(),
		panel.grid = element_blank(),
		axis.text.x = element_text(size = 10),
		axis.text.y = element_text(size = 8),
		axis.title = element_blank()
	)

ggsave(here("img", "attrition_familiarity.png"))
```




## By animacy {.tabset }

```{r attrition_animacy_target, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
attrition %>% 
	left_join(distinct(stimuli, test_language, list, trial, trial_type, is_animate_target)) %>%
	mutate(is_animate_target = ifelse(is_animate_target, "Animate", "Inanimate")) %>% 
	drop_na(trial_type, is_animate_target) %>% 
	count(trial_type, age_group, valid_status, trial_type, is_animate_target) %>% 
	ggplot(aes(as.factor(is_animate_target), n, fill = valid_status, colour = valid_status)) +
	facet_grid(trial_type~age_group) +
	geom_col(position = position_fill(), colour = "white") +
	labs(x = "Trial type", y = "Trials", colour = "Validity", fill = "Validity") +
	guides(fill = guide_legend(ncol = 2), colour = guide_legend(ncol = 2))	+
	scale_y_continuous(labels = percent) +
	coord_flip() +
	theme(
		legend.position = "top",
		legend.title = element_blank(),
		panel.grid = element_blank(),
		axis.text.x = element_text(size = 10),
		axis.text.y = element_text(size = 8),
		axis.title = element_blank()
	)

```


## By category {.tabset}

```{r attrition_category_target, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
attrition %>% 
	left_join(distinct(stimuli, test_language, list, trial, trial_type, category_target)) %>%
	drop_na(
		trial_type, 
		category_target
	) %>% 
	count(
		trial_type,
		age_group,
		valid_status,
		trial_type, 
		category_target
	) %>% 
	ggplot() +
	aes(
		fct_rev(category_target),
		n, 
		fill = valid_status,
		colour = valid_status
	) +
	facet_wrap(
		trial_type~age_group, 
		labeller = label_wrap_gen(multi_line = FALSE),
		scales = "free_y"
	) +
	geom_col(
		position = position_fill(),
		colour = "white"
	) +
	labs(
		x = "Trial type", 
		y = "Trials",
		colour = "Validity",
		fill = "Validity"
	) +
	guides(
		fill = guide_legend(ncol = 2),
		colour = guide_legend(ncol = 2)
	)	+
	scale_y_continuous(labels = percent) +
	coord_flip() +
	theme(
		legend.position = "top",
		legend.title = element_blank(),
		panel.grid = element_blank(),
		axis.text.x = element_text(size = 10),
		axis.text.y = element_text(size = 8),
		axis.title = element_blank()
	)
```
