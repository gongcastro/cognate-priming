---
title: "Results"
output: github_document
always_allow_html: true
date: "`r paste0('Updated: ', format(Sys.Date(), '%d/%m/%Y'))`"
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = FALSE,
	message = TRUE,
	warning = TRUE, 
	cache.extra = knitr::rand_seed,
	out.width = "80%",
	results = "asis",
	dpi = 300,
	dev.args = list(png = list(type = "cairo"))
)

options(
	knitr.kable.NA = '-',
	knitr.duplicate.label = "allow",
	ggplot2.discrete.fill = pal_d3()(4),
	ggplot2.discrete.colour = pal_d3()(4)
)

```



```{r params, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}

# load objects
tar_load_globals()
tar_load_all()

theme_set(theme_custom()) # in utils.R

attrition <- attrition %>% 
	mutate(
		valid_gaze = valid_gaze_prime & valid_gaze_target,
		valid_status = case_when(
			!valid_gaze ~ "Invalid gaze",
			!valid_participant ~ "Invalid participant",
			TRUE ~ "Valid"
		))


participants <- participants %>% 
	left_join(distinct(attrition, participant, valid_participant)) %>% 
	drop_na(participant) %>% 
	left_join(vocabulary) %>% 
	mutate(
		vocab_size_l1_center = scale(vocab_size_l1)[,1],
		vocab_size_total_center = scale(vocab_size_total)[,1]
	)


```


# Model comparison

```{r model-comparison, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}

# model_comparison <- waics_l1 %>% 
# 	map("estimates") %>% 
# 	map(function(x) rownames_to_column(as.data.frame(x), "variable")) %>% 
# 	bind_rows(.id = "model") %>%
# 	clean_names() 
# 	pivot_wider(names_from = variable, values_from = c(estimate, se)) %>% 
# 	relocate(model, matches("estimate"), matches("elpd"), matches("_p_")) %>% 
# 	mutate(
# 		model = c(
# 			"Intercept",
# 			"... + Trial type",
# 			"... + Group \u00d7Trial type\u00d7Group",
# 			"... + Vocab. + Trial type\u00d7Vocab. + Group\u00d7Vocab.",
# 			"... + Trial type\u00d7Vocab. + Group\u00d7Vocab. + Trial type\u00d7Group\u00d7Vocab."
# 		)
# 	) %>% 
# 	gt() %>% 
# 	fmt_number(-model) %>% 
# 	tab_spanner("WAIC", matches("waic")) %>% 
# 	tab_spanner(md("WAIC<sub>ELPD</sub>"), matches("elpd")) %>% 
# 	tab_spanner(md("WAIC<sub>*p*</sub>"), matches("_p_")) %>% 
# 	cols_label(
# 		model = "Model",
# 		estimate_elpd_waic = "Estimate",
# 		estimate_waic = "Estimate",
# 		estimate_p_waic = "Estimate",
# 		se_elpd_waic = md("*SE*"),
# 		se_waic = md("*SE*"),
# 		se_p_waic = md("*SE*"),
# 	) %>% 
# 	cols_align("right", "model") %>% 
# 	tab_style(
# 		cell_text(weight = "bold"),
# 		cells_column_spanners()
# 	) %>% 
# 	tab_style(
# 		cell_text(style = "italic"),
# 		cells_column_labels()
# 	)
# 
# gtsave(model_comparison, here("img", "model_comparison.png"))
# 
# 
# as_raw_html(model_comparison)


```


# Model with total vocabulary

## Fixed effects


```{r fixed_effects_table, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
str_repl <- c(
	
	# cubic terms ----
	"b_Itime_bin_centerE3:trial_typerelated_unrelated:lpLPMonvs.Bil:age_group21_25" = 
		"Trial type (U vs. C+NC) \u00d7 Group \u00d7 Age (21 vs. 25 mo)",
	
	"b_Itime_bin_centerE3:trial_typerelated_unrelated:lpLPMonvs.Bil:age_group25_30" = 
		"Trial type (U vs. C+NC) \u00d7 Group \u00d7 Age (25 vs. 30 mo)",
	
	"b_Itime_bin_centerE3:trial_typecognate_noncognate:lpLPMonvs.Bil:age_group21_25" = 
		"Trial type (C vs. NC) \u00d7 Group \u00d7 Age (21 vs. 25 mo)",
	
	"b_Itime_bin_centerE3:trial_typecognate_noncognate:lpLPMonvs.Bil:age_group25_30" = 
		"Trial type (C vs. NC) \u00d7 Group \u00d7 Age (25 vs. 30 mo)",
	
	"b_Itime_bin_centerE3:trial_typecognate_noncognate:lpLPMonvs.Bil" = 
		"Trial type (C vs. NC) \u00d7 Group",
	
	"b_Itime_bin_centerE3:trial_typerelated_unrelated:lpLPMonvs.Bil" = 
		"Trial type (U vs. C+NC) \u00d7 Group",
	
	"b_Itime_bin_centerE3:trial_typerelated_unrelated:age_group21_25" = 
		"Trial type (U vs. C+NC) \u00d7 Age (21 vs. 25 mo)",
	
	"b_Itime_bin_centerE3:trial_typerelated_unrelated:age_group25_30" = 
		"Trial type (U vs. C+NC) \u00d7 Age (25 vs. 30 mo)",
	
	"b_Itime_bin_centerE3:trial_typecognate_noncognate:age_group21_25" = 
		"Trial type (C vs. NC) \u00d7 Age (21 vs. 25 mo)",
	
	"b_Itime_bin_centerE3:trial_typecognate_noncognate:age_group25_30" = 
		"Trial type (C vs. NC) \u00d7 Age (25 vs. 30 mo)",
	
	"b_Itime_bin_centerE3:lpLPMonvs.Bil:age_group21_25" =
		"Group (ML vs. BL) \u00d7 Age (21 vs. 25 mo)",
	
	"b_Itime_bin_centerE3:lpLPMonvs.Bil:age_group25_30" =
		"Group (ML vs. BL) \u00d7 Age (25 vs. 30 mo)",
	
	"b_Itime_bin_centerE3:lpLPMonvs.Bil" = 
		"Group (ML vs. BL)",
	
	"b_Itime_bin_centerE3:age_group21_25" = 
		"Age (21 vs. 25 mo)",
	
	"b_Itime_bin_centerE3:age_group25_30" = 
		"Age (25 vs. 30 mo)",
	
	"b_Itime_bin_centerE3:trial_typecognate_noncognate" =
		"Trial type (C vs. NC)",
	
	"b_Itime_bin_centerE3:trial_typerelated_unrelated" =
		"Trial type (U vs. C+NC)",
	
	"b_Itime_bin_centerE3" = 
		"Intercept",
	
	# quadratic terms ----
	"b_Itime_bin_centerE2:trial_typerelated_unrelated:lpLPMonvs.Bil:age_group21_25" = 
		"Trial type (U vs. C+NC) \u00d7 Group \u00d7 Age (21 vs. 25 mo)",
	
	"b_Itime_bin_centerE2:trial_typerelated_unrelated:lpLPMonvs.Bil:age_group25_30" = 
		"Trial type (U vs. C+NC) \u00d7 Group \u00d7 Age (25 vs. 30 mo)",
	
	"b_Itime_bin_centerE2:trial_typecognate_noncognate:lpLPMonvs.Bil:age_group21_25" = 
		"Trial type (C vs. NC) \u00d7 Group \u00d7 Age (21 vs. 25 mo)",
	
	"b_Itime_bin_centerE2:trial_typecognate_noncognate:lpLPMonvs.Bil:age_group25_30" = 
		"Trial type (C vs. NC) \u00d7 Group \u00d7 Age (25 vs. 30 mo)",
	
	"b_Itime_bin_centerE2:trial_typecognate_noncognate:lpLPMonvs.Bil" = 
		"Trial type (C vs. NC) \u00d7 Group",
	
	"b_Itime_bin_centerE2:trial_typerelated_unrelated:lpLPMonvs.Bil" = 
		"Trial type (U vs. C+NC) \u00d7 Group",
	
	"b_Itime_bin_centerE2:trial_typerelated_unrelated:age_group21_25" = 
		"Trial type (U vs. C+NC) \u00d7 Age (21 vs. 25 mo)",
	
	"b_Itime_bin_centerE2:trial_typerelated_unrelated:age_group25_30" = 
		"Trial type (U vs. C+NC) \u00d7 Age (25 vs. 30 mo)",
	
	"b_Itime_bin_centerE2:trial_typecognate_noncognate:age_group21_25" = 
		"Trial type (C vs. NC) \u00d7 Age (21 vs. 25 mo)",
	
	"b_Itime_bin_centerE2:trial_typecognate_noncognate:age_group25_30" = 
		"Trial type (C vs. NC) \u00d7 Age (25 vs. 30 mo)",
	
	"b_Itime_bin_centerE2:lpLPMonvs.Bil:age_group21_25" =
		"Group (ML vs. BL) \u00d7 Age (21 vs. 25 mo)",
	
	"b_Itime_bin_centerE2:lpLPMonvs.Bil:age_group25_30" =
		"Group (ML vs. BL) \u00d7 Age (25 vs. 30 mo)",
	
	"b_Itime_bin_centerE2:lpLPMonvs.Bil" = 
		"Group (ML vs. BL)",
	
	"b_Itime_bin_centerE2:age_group21_25" = 
		"Age (21 vs. 25 mo)",
	
	"b_Itime_bin_centerE2:age_group25_30" = 
		"Age (25 vs. 30 mo)",
	
	"b_Itime_bin_centerE2:trial_typecognate_noncognate" =
		"Trial type (C vs. NC)",
	
	"b_Itime_bin_centerE2:trial_typerelated_unrelated" =
		"Trial type (U vs. C+NC)",
	
	"b_Itime_bin_centerE2" = 
		"Intercept",
	
	# linear terms ----
	"b_time_bin_center:trial_typerelated_unrelated:lpLPMonvs.Bil:age_group21_25" = 
		"Trial type (U vs. C+NC) \u00d7 Group \u00d7 Age (21 vs. 25 mo)",
	
	"b_time_bin_center:trial_typerelated_unrelated:lpLPMonvs.Bil:age_group25_30" = 
		"Trial type (U vs. C+NC) \u00d7 Group \u00d7 Age (25 vs. 30 mo)",
	
	"b_time_bin_center:trial_typecognate_noncognate:lpLPMonvs.Bil:age_group21_25" = 
		"Trial type (C vs. NC) \u00d7 Group \u00d7 Age (21 vs. 25 mo)",
	
	"b_time_bin_center:trial_typecognate_noncognate:lpLPMonvs.Bil:age_group25_30" = 
		"Trial type (C vs. NC) \u00d7 Group \u00d7 Age (25 vs. 30 mo)",
	
	"b_time_bin_center:trial_typecognate_noncognate:lpLPMonvs.Bil" = 
		"Trial type (C vs. NC) \u00d7 Group",
	
	"b_time_bin_center:trial_typerelated_unrelated:lpLPMonvs.Bil" = 
		"Trial type (U vs. C+NC) \u00d7 Group",
	
	"b_time_bin_center:trial_typerelated_unrelated:age_group21_25" = 
		"Trial type (U vs. C+NC) \u00d7 Age (21 vs. 25 mo)",
	
	"b_time_bin_center:trial_typerelated_unrelated:age_group25_30" = 
		"Trial type (U vs. C+NC) \u00d7 Age (25 vs. 30 mo)",
	
	"b_time_bin_center:trial_typecognate_noncognate:age_group21_25" = 
		"Trial type (C vs. NC) \u00d7 Age (21 vs. 25 mo)",
	
	"b_time_bin_center:trial_typecognate_noncognate:age_group25_30" = 
		"Trial type (C vs. NC) \u00d7 Age (25 vs. 30 mo)",
	
	"b_time_bin_center:lpLPMonvs.Bil:age_group21_25" =
		"Group (ML vs. BL) \u00d7 Age (21 vs. 25 mo)",
	
	"b_time_bin_center:lpLPMonvs.Bil:age_group25_30" =
		"Group (ML vs. BL) \u00d7 Age (25 vs. 30 mo)",
	
	"b_time_bin_center:lpLPMonvs.Bil" = 
		"Group (ML vs. BL)",
	
	"b_time_bin_center:age_group21_25" = 
		"Age (21 vs. 25 mo)",
	
	"b_time_bin_center:age_group25_30" = 
		"Age (25 vs. 30 mo)",
	
	"b_time_bin_center:trial_typecognate_noncognate" =
		"Trial type (C vs. NC)",
	
	"b_time_bin_center:trial_typerelated_unrelated" =
		"Trial type (U vs. C+NC)",
	
	"b_time_bin_center" = 
		"Intercept",
	
	# marginal terms ----
	"b_trial_typerelated_unrelated:lpLPMonvs.Bil:age_group21_25" = 
		"Trial type (U vs. C+NC) \u00d7 Group \u00d7 Age (21 vs. 25 mo)",
	
	"b_trial_typerelated_unrelated:lpLPMonvs.Bil:age_group25_30" = 
		"Trial type (U vs. C+NC) \u00d7 Group \u00d7 Age (25 vs. 30 mo)",
	
	"b_trial_typecognate_noncognate:lpLPMonvs.Bil:age_group21_25" = 
		"Trial type (C vs. NC) \u00d7 Group \u00d7 Age (21 vs. 25 mo)",
	
	"b_trial_typecognate_noncognate:lpLPMonvs.Bil:age_group25_30" = 
		"Trial type (C vs. NC) \u00d7 Group \u00d7 Age (25 vs. 30 mo)",
	
	"b_trial_typecognate_noncognate:lpLPMonvs.Bil" = 
		"Trial type (C vs. NC) \u00d7 Group",
	
	"b_trial_typerelated_unrelated:lpLPMonvs.Bil" = 
		"Trial type (U vs. C+NC) \u00d7 Group",
	
	"b_trial_typerelated_unrelated:age_group21_25" = 
		"Trial type (U vs. C+NC) \u00d7 Age (21 vs. 25 mo)",
	
	"b_trial_typerelated_unrelated:age_group25_30" = 
		"Trial type (U vs. C+NC) \u00d7 Age (25 vs. 30 mo)",
	
	"b_trial_typecognate_noncognate:age_group21_25" = 
		"Trial type (C vs. NC) \u00d7 Age (21 vs. 25 mo)",
	
	"b_trial_typecognate_noncognate:age_group25_30" = 
		"Trial type (C vs. NC) \u00d7 Age (25 vs. 30 mo)",
	
	"b_lpLPMonvs.Bil:age_group21_25" =
		"Group (ML vs. BL) \u00d7 Age (21 vs. 25 mo)",
	
	"b_lpLPMonvs.Bil:age_group25_30" =
		"Group (ML vs. BL) \u00d7 Age (25 vs. 30 mo)",
	
	"b_lpLPMonvs.Bil" = 
		"Group (ML vs. BL)",
	
	"b_age_group21_25" = 
		"Age (21 vs. 25 mo)",
	
	"b_age_group25_30" = 
		"Age (25 vs. 30 mo)",
	
	"b_trial_typecognate_noncognate" =
		"Trial type (C vs. NC)",
	
	"b_trial_typerelated_unrelated" =
		"Trial type (U vs. C+NC)",
	
	"b_Intercept" = "Intercept",
	
	# sigma
	"sigma" = "Standard deviation"
)



# cubic terms ----
levels <- c(
	"Trial type (U vs. C+NC) \u00d7 Group \u00d7 Age (21 vs. 25 mo)",
	"Trial type (U vs. C+NC) \u00d7 Group \u00d7 Age (25 vs. 30 mo)",
	"Trial type (C vs. NC) \u00d7 Group \u00d7 Age (21 vs. 25 mo)",
	"Trial type (C vs. NC) \u00d7 Group \u00d7 Age (25 vs. 30 mo)",
	"Trial type (C vs. NC) \u00d7 Group",
	"Trial type (U vs. C+NC) \u00d7 Group",
	"Trial type (U vs. C+NC) \u00d7 Age (21 vs. 25 mo)",
	"Trial type (U vs. C+NC) \u00d7 Age (25 vs. 30 mo)",
	"Trial type (C vs. NC) \u00d7 Age (21 vs. 25 mo)",
	"Trial type (C vs. NC) \u00d7 Age (25 vs. 30 mo)",
	"Group (ML vs. BL) \u00d7 Age (21 vs. 25 mo)",
	"Group (ML vs. BL) \u00d7 Age (25 vs. 30 mo)",
	"Group (ML vs. BL)",
	"Age (21 vs. 25 mo)",
	"Age (25 vs. 30 mo)",
	"Trial type (C vs. NC)",
	"Trial type (U vs. C+NC)",
	"Standard deviation",
	"Intercept"
)

draws <- gather_draws(
	fit_3, 
	`b_.*`, 
	`sigma`,
	regex = TRUE
) %>% 
	mutate(
		.variable_name = str_replace_all(.variable, str_repl) %>% 
			factor(levels = levels),
		type = case_when(
			str_detect(.variable, "Itime_bin_centerE2") ~ "Quadratic time",
			str_detect(.variable, "Itime_bin_centerE3") ~ "Cubic time",
			str_detect(.variable, "time_bin_center") & 
				str_detect(.variable, "E2|E3", negate = TRUE) ~ "Linear time",
			str_detect(.variable, "sigma") ~ "Distributional",
			.variable=="b_Intercept" ~ "Distributional",
			TRUE ~ "Main effects",
		) %>% 
			factor(
				levels = c(
					"Main effects", 
					"Linear time", 
					"Quadratic time", 
					"Cubic time",
					"Distributional"
				), 
				ordered = TRUE
			),
		.value = ifelse(
			(.variable %in% c("sigma", "b_Intercept")) & (type=="Main effects"),
			inv_logit(.value),
			.value/4
		),
	)

coefs_tab <- draws %>% 
	group_by(.variable_name, type) %>% 
	mean_qi(
		.exclude = c(
			".chain",
			".iteration",
			".variable",
			".draw",
			".row",
			".variable_name", 
			"type"
		)
	) %>%  
	mutate(.variable_name = factor(.variable_name, levels = rev(levels))) %>% 
	arrange(type, .variable_name) %>% 
	select(type, .variable_name, .value, .lower, .upper) %>% 
	gt(
		rowname_col = ".variable", 
		groupname_col = "type"
	)  %>% 
	row_group_order(
		groups = c(
			"Main effects", 
			"Linear time", 
			"Quadratic time", 
			"Cubic time",
			"Distributional"
		)
	) %>% 
	fmt_percent(3) %>%
	fmt_number(4:5, scale_by = 100) %>% 
	cols_merge(
		c(".lower", ".upper"), 
		pattern = "[{1}, {2}]"
	) %>% 
	cols_label(
		.variable_name = md("**Predictor**"),
		.value = md("**Mean**"),
		.lower = md("**95% CrI**")
	) %>% 
	tab_style(
		cell_text(weight = "bold", style = "italic"),
		cells_row_groups()
	) %>% 
	tab_style(
		cell_text(align = "left"),
		cells_body()
	) %>% 
	tab_style(
		style = cell_fill(color = pal_d3()(2)[1]),
		locations = cells_body(
			columns = everything(),
			rows = .lower > 0
		)
	) %>% 
	tab_style(
		style = cell_fill(color = pal_d3()(2)[2]),
		locations = cells_body(
			columns = everything(),
			rows = .upper < 0
		)
	)

gtsave(coefs_tab, here("img", "coefs_tab.png"))
as_raw_html(coefs_tab)
```


```{r main_effects_plot, echo=FALSE, message=FALSE, warning=FALSE, fig.height=10, fig.width=15}

draws %>% 
	filter(!(type %in% c("Standard deviation", "Intercept"))) %>% 
	group_by(type, .variable, .variable_name) %>% 
	summarise(
		.lower = quantile(.value, 0.025),
		.upper = quantile(.value, 0.975),
		.value = mean(.value),
		.groups = "drop"
	) %>% 
	mutate(
		excludes_zero = (.lower > 0) | (.upper < 0),
		excludes_zero = ifelse(excludes_zero, "Yes", "No") %>% 
			factor(levels = c("Yes", "No"))
	) %>% 
	ggplot() +
	aes(
		x = .value, 
		y = .variable_name,
		xmin = .lower,
		xmax = .upper,
		colour = excludes_zero
	) +
	facet_wrap(
		~type, 
		nrow = 1, 
		scales = "free_x"
	) +
	geom_vline(
		xintercept = 0,
		colour = "black", 
		linetype = "dashed"
	) +
	geom_pointinterval(
		size = 5,
		point_size = 3
	) +
	labs(
		x = "Value", 
		y = "Variable", 
		fill = "CrI", 
		alpha = "CrI",
		title = "Main effects",
		subtitle = "Mean and 95% credible interval of posterior distribution",
		colour = "Interval excludes zero?"
	) +
	scale_color_manual(values = rev(pal_d3()(2))) +
	scale_x_continuous(
		labels = percent
	) +
	theme(
		legend.position = "top",
		axis.title.y = element_blank(),
		axis.text.y = element_text(hjust = 1),
		panel.border = element_rect(colour = "black", fill = NA)
	)

ggsave(here("img", "coefficients.png"), height = 10, width = 16)
```




## Marginal means

### Posterior predictions (after seeing the data)

```{r gaze_time, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}

sample_size <- participants %>% 
	filter(valid_participant) %>% 
	count(lp, age_group)

observed <- fit_3$data %>% 
	group_by(time_bin_center, trial_type, lp, age_group) %>% 
	summarise(
		.value = logit_to_prob(mean(logit, na.rm = TRUE)),
		n = n(),
		.groups = "drop"
	) %>% 
	mutate(.value_se = sd(.value, na.rm = TRUE) / sqrt(n))

nd <- expand_grid(
	lp = c("Monolingual", "Bilingual"),
	trial_type = unique(gaze$trial_type),
	age_group = unique(gaze$age_group),
	time_bin_center = seq(
		min(gaze$time_bin_center), 
		max(gaze$time_bin_center), 
		0.1
	)
)

m <- epred_draws(
	object = fit_3, 
	newdata = nd, 
	# ndraws = 20,
	re_formula = NA
) %>% 
	mutate(
		.value = logit_to_prob(.epred)
	)

m %>% 
	ggplot() +
	aes(
		x = time_bin_center, 
		y = .value,
		colour = trial_type,
		fill = trial_type,
		linetype = trial_type,
		shape = trial_type
	) +
	facet_wrap(
		fct_rev(lp)~age_group,
		scales = "free",
		labeller = label_wrap_gen(multi_line = FALSE)
	) +
	geom_hline(
		yintercept = 0.5,
		colour = "black"
	) +
	# geom_line(
	# 	aes(group = interaction(trial_type, lp, .draw),
	# 		colour = trial_type),
	# 	alpha = 0.5, size = 0.65
	# ) +
	stat_summary(
		fun.data = mean_qi,
		geom = "ribbon",
		colour = NA,
		alpha = 0.25
	) +
	stat_summary(
		fun = mean,
		geom = "line",
		size = 0.75
	) +
	geom_text(
		data = sample_size,
		aes(
			x = min(gaze$time_bin_center),
			y = 1,
			label = paste0("N = ", n)
		),
		colour = "black",
		hjust = 0,
		vjust = 1,
		inherit.aes = FALSE
	) +
	geom_point(
		data = observed,
		size = 1.5
	) +
	labs(
		x = "Time from target-distractor onset (ms)", 
		y = "Posterior mean PTLT",
		colour = "Trial type",
		fill = "Trial type", 
		shape = "Trial type",
		linetype = "Trial type"
	) +
	scale_color_d3() +
	scale_fill_d3() +
	scale_x_continuous(
		breaks = seq(
			min(gaze$time_bin_center),
			max(gaze$time_bin_center),
			len = 6
		),
		labels = format(
			100*(seq(3, 18, 3)), 
			big.mark = ",", trim = TRUE
		)
	) +
	scale_y_continuous(
		limits = c(0, 1),
		labels = percent
	) + 
	theme_custom() +
	theme(
		legend.position = "top",
		legend.title = element_blank(),
		axis.text.x = element_text(face = "plain"),
		axis.text.y = element_text(face = "plain"),
		panel.grid.major.x = element_blank(),
		panel.grid.minor.x = element_blank(),
		panel.background = element_rect(
			fill = NA, 
			colour = NA
		),
		plot.background = element_rect(
			fill = "white",
			colour = NA
		)
	) 


ggsave(
	here("img", "predictions.png"),
	dpi = 2000,
	height = 7,
	width = 12
)

```

```{r gaze_time_observed, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}

observed %>% 
	ggplot() +
	aes(
		x = time_bin_center, 
		y = .value,
		colour = trial_type,
		fill = trial_type,
		linetype = trial_type,
		shape = trial_type
	) +
	facet_wrap(
		fct_rev(lp)~age_group,
		scales = "free",
		labeller = label_wrap_gen(multi_line = FALSE)
	) +
	geom_hline(
		yintercept = 0.5,
		colour = "black"
	) +
	geom_line() +
	geom_point(
		size = 2
	) +
	geom_text(
		data = sample_size,
		aes(
			x = min(gaze$time_bin_center),
			y = 1,
			label = paste0("N = ", n)
		),
		colour = "black",
		hjust = 0,
		vjust = 1,
		inherit.aes = FALSE
	) +
	labs(
		x = "Time from target-distractor onset (ms)", 
		y = "Observed PTLT",
		colour = "Trial type",
		fill = "Trial type", 
		shape = "Trial type",
		linetype = "Trial type"
	) +
	scale_color_d3() +
	scale_fill_d3() +
	scale_x_continuous(
		breaks = seq(
			min(gaze$time_bin_center),
			max(gaze$time_bin_center),
			len = 6
		),
		labels = format(
			100*(seq(3, 18, 3)), 
			big.mark = ",", trim = TRUE
		)
	) +
	scale_y_continuous(
		limits = c(0, 1),
		labels = percent
	) + 
	theme(
		legend.position = "top",
		legend.title = element_blank(),
		axis.text.x = element_text(face = "plain"),
		axis.text.y = element_text(face = "plain"),
		panel.grid.major.x = element_blank(),
		panel.grid.minor.x = element_blank(),
		panel.background = element_rect(
			fill = NA, 
			colour = NA
		),
		plot.background = element_rect(
			fill = "white",
			colour = NA
		)
	) 


ggsave(
	here("img", "predictions_observed.png"),
	dpi = 2000,
	height = 7,
	width = 12
)
```


## Marginal means {.tabset }

```{r coefs-aggregated, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}

str_repl_agg <- c(
	
	# marginal terms ----
	"b_trial_typerelated_unrelated:lpLPMonvs.Bil:age_group21_25" = 
		"Trial type (U vs. C+NC) \u00d7 Group \u00d7 Age (21 vs. 25 mo)",
	"b_trial_typerelated_unrelated:lpLPMonvs.Bil:age_group25_30" = 
		"Trial type (U vs. C+NC) \u00d7 Group \u00d7 Age (25 vs. 30 mo)",
	"b_trial_typecognate_noncognate:lpLPMonvs.Bil:age_group21_25" = 
		"Trial type (C vs. NC) \u00d7 Group \u00d7 Age (21 vs. 25 mo)",
	"b_trial_typecognate_noncognate:lpLPMonvs.Bil:age_group25_30" = 
		"Trial type (C vs. NC) \u00d7 Group \u00d7 Age (25 vs. 30 mo)",
	"b_trial_typecognate_noncognate:lpLPMonvs.Bil" = 
		"Trial type (C vs. NC) \u00d7 Group",
	"b_trial_typerelated_unrelated:lpLPMonvs.Bil" = 
		"Trial type (U vs. C+NC) \u00d7 Group",
	"b_trial_typerelated_unrelated:age_group21_25" = 
		"Trial type (U vs. C+NC) \u00d7 Age (21 vs. 25 mo)",
	"b_trial_typerelated_unrelated:age_group25_30" = 
		"Trial type (U vs. C+NC) \u00d7 Age (25 vs. 30 mo)",
	"b_trial_typecognate_noncognate:age_group21_25" = 
		"Trial type (C vs. NC) \u00d7 Age (21 vs. 25 mo)",
	"b_trial_typecognate_noncognate:age_group25_30" = 
		"Trial type (C vs. NC) \u00d7 Age (25 vs. 30 mo)",
	"b_lpLPMonvs.Bil:age_group21_25" =
		"Group (ML vs. BL) \u00d7 Age (21 vs. 25 mo)",
	"b_lpLPMonvs.Bil:age_group25_30" =
		"Group (ML vs. BL) \u00d7 Age (25 vs. 30 mo)",
	"b_lpLPMonvs.Bil" = 
		"Group (ML vs. BL)",
	"b_age_group21_25" = 
		"Age (21 vs. 25 mo)",
	"b_age_group25_30" = 
		"Age (25 vs. 30 mo)",
	"b_trial_typecognate_noncognate" =
		"Trial type (C vs. NC)",
	"b_trial_typerelated_unrelated" =
		"Trial type (U vs. C+NC)",
	"b_Intercept" = "Intercept",
	"sigma" = "Standard deviation"
)



levels_agg <- c(
	"Trial type (U vs. C+NC) \u00d7 Group \u00d7 Age (21 vs. 25 mo)",
	"Trial type (U vs. C+NC) \u00d7 Group \u00d7 Age (25 vs. 30 mo)",
	"Trial type (C vs. NC) \u00d7 Group \u00d7 Age (21 vs. 25 mo)",
	"Trial type (C vs. NC) \u00d7 Group \u00d7 Age (25 vs. 30 mo)",
	"Trial type (C vs. NC) \u00d7 Group",
	"Trial type (U vs. C+NC) \u00d7 Group",
	"Trial type (U vs. C+NC) \u00d7 Age (21 vs. 25 mo)",
	"Trial type (U vs. C+NC) \u00d7 Age (25 vs. 30 mo)",
	"Trial type (C vs. NC) \u00d7 Age (21 vs. 25 mo)",
	"Trial type (C vs. NC) \u00d7 Age (25 vs. 30 mo)",
	"Group (ML vs. BL) \u00d7 Age (21 vs. 25 mo)",
	"Group (ML vs. BL) \u00d7 Age (25 vs. 30 mo)",
	"Group (ML vs. BL)",
	"Age (21 vs. 25 mo)",
	"Age (25 vs. 30 mo)",
	"Trial type (C vs. NC)",
	"Trial type (U vs. C+NC)",
	"Standard deviation",
	"Intercept"
)

draws_agg <- gather_draws(
	fit_agg_3, 
	`b_.*`, 
	`sigma`,
	regex = TRUE
) %>% 
	mutate(
		.value = ifelse(
			.variable %in% c("sigma", "b_Intercept"),
			inv_logit_scaled(.value),
			.value/4
		),
		.variable_name = str_replace_all(.variable, str_repl_agg) %>% 
			factor(levels = levels_agg, ordered = TRUE)
	)

a <- draws_agg %>% 
	# filter(!(type %in% c("Sigma", "Intercept"))) %>% 
	group_by(.variable, .variable_name) %>% 
	summarise(
		.lower = quantile(.value, 0.025),
		.upper = quantile(.value, 0.975),
		.value = mean(.value),
		.groups = "drop"
	) %>% 
	mutate(
		excludes_zero = (.lower > 0) | (.upper < 0),
		excludes_zero = ifelse(excludes_zero, "Yes", "No") %>% 
			factor(levels = c("Yes", "No"))
	) %>% 
	ggplot() +
	aes(
		x = .value, 
		y = .variable_name,
		xmin = .lower,
		xmax = .upper,
		colour = excludes_zero
	) +
	geom_vline(
		xintercept = 0,
		colour = "black", 
		linetype = "dashed"
	) +
	geom_pointinterval(
		size = 5,
		point_size = 3
	) +
	labs(
		x = "Value", 
		y = "Variable", 
		fill = "CrI", 
		alpha = "CrI",
		title = "Main effects",
		subtitle = "Mean and 95% credible interval of posterior distribution",
		colour = "Interval excludes zero?"
	) +
	scale_color_manual(values = rev(pal_d3()(2))) +
	scale_x_continuous(
		labels = percent
	) +
	theme(
		legend.position = "top",
		axis.title.y = element_blank(),
		axis.text.y = element_text(hjust = 1),
		panel.border = element_rect(colour = "black", fill = NA)
	)

ggsave(here("img", "coefficients_agg.png"), height = 10, width = 13)

```


```{r gaze_marginal, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE, fig.width=7, fig.height=7}

m <- emmeans(
	fit_agg_3, 
	~trial_type | age_group, 
	by = "lp",
	epred = TRUE
) 

m_draws <- gather_emmeans_draws(m) %>% 
	as_tibble() %>% 
	mutate_at(vars(.value), function(x) ifelse(x < 0, 0, x)) %>% 
	mutate_at(vars(.value), function(x) ifelse(x > 1, 1, x)) %>% 
	mutate(.value = inv_logit_scaled(.value))

observed <- fit_agg_3$data %>% 
	mutate(.value = inv_logit_scaled(logit))

m_draws %>% 
	ggplot() +
	aes(
		x = trial_type, 
		y = .value, 
		fill = trial_type,
		colour = trial_type
	) +
	facet_grid(lp~age_group) +
	geom_hline(
		yintercept = 0.5,
		linetype = "dotted"
	) +
	geom_text(
		data = sample_size,
		aes(
			x = "Cognate",
			y = 1,
			label = paste0("N = ", n)
		),
		colour = "black",
		hjust = 0,
		vjust = 1,
		inherit.aes = FALSE,
		position = position_nudge(x = -0.75)
	) +
	stat_pointinterval(
		data = observed,
		position = position_nudge(x = -0.4),
		.width = 0.95,
		size = 4,
		point_size = 3
	) +
	geom_point(
		data = observed,
		position = position_jitter(width = 0.05),
		shape = 1,
		stroke = 1,
		size = 2,
		alpha = 0.25
	) +
	stat_pointinterval(
		color = "black",
		position = position_nudge(x = -0.2),
		point_size = 3,
		.width = 0,
		shape = 4,
		show.legend = FALSE
	) +
	labs(
		x = "Trial type",
		y = "PTLT",
		colour = "Trial type", 
		fill = "Trial type",
		alpha = "CrI",
		title = "PTLT aggregated for time windows of interest",
		subtitle = "Black crosses indicate the mean of the posterior predictions of the model.\nPoints and whiskers indicate observed PTLTS."
	) +
	scale_y_continuous(
		limits = c(0, 1),
		labels = percent
	)  +
	scale_fill_d3() +
	scale_color_d3() +
	theme(
		legend.position = "top",
		legend.title = element_blank(),
		axis.text.x = element_text(colour = "black", hjust = 0.5),
		axis.title.x = element_blank(),
		panel.grid.major.y = element_line(colour = "grey", linetype = "dotted"),
		panel.background = element_rect(fill = NA, colour = "grey")
	)

ggsave(here("img", "predictions_aggregated.png"), height = 8, width = 15)


```


