---
title: "Results"
output: github_document
always_allow_html: true
date: "`r paste0('Updated: ', format(Sys.Date(), '%d/%m/%Y'))`"
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = FALSE,
	message = TRUE,
	warning = TRUE, 
	cache.extra = knitr::rand_seed,
	out.width = "80%",
	results = "asis",
	dpi = 300,
	dev.args = list(png = list(type = "cairo"))
)

options(
	knitr.kable.NA = '-',
	knitr.duplicate.label = "allow",
	ggplot2.discrete.fill = pal_d3()(4),
	ggplot2.discrete.colour = pal_d3()(4)
)

```



```{r params, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}

# load objects
tar_load_globals()
tar_load_all()

theme_set(theme_custom()) # in utils.R

attrition <- attrition %>% 
	mutate(
		valid_gaze = valid_gaze_prime & valid_gaze_target,
		valid_status = case_when(
			!valid_gaze ~ "Invalid gaze",
			!valid_participant ~ "Invalid participant",
			TRUE ~ "Valid"
		))


participants <- participants %>% 
	left_join(distinct(attrition, participant, valid_participant)) %>% 
	drop_na(participant) %>% 
	left_join(vocabulary) %>% 
	mutate(
		vocab_size_l1_center = scale(vocab_size_l1)[,1],
		vocab_size_total_center = scale(vocab_size_total)[,1]
	)


```


# Model comparison

```{r model-comparison, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}

# model_comparison <- waics_l1 %>% 
# 	map("estimates") %>% 
# 	map(function(x) rownames_to_column(as.data.frame(x), "variable")) %>% 
# 	bind_rows(.id = "model") %>%
# 	clean_names() 
# 	pivot_wider(names_from = variable, values_from = c(estimate, se)) %>% 
# 	relocate(model, matches("estimate"), matches("elpd"), matches("_p_")) %>% 
# 	mutate(
# 		model = c(
# 			"Intercept",
# 			"... + Trial type",
# 			"... + Group \u00d7Trial type\u00d7Group",
# 			"... + Vocab. + Trial type\u00d7Vocab. + Group\u00d7Vocab.",
# 			"... + Trial type\u00d7Vocab. + Group\u00d7Vocab. + Trial type\u00d7Group\u00d7Vocab."
# 		)
# 	) %>% 
# 	gt() %>% 
# 	fmt_number(-model) %>% 
# 	tab_spanner("WAIC", matches("waic")) %>% 
# 	tab_spanner(md("WAIC<sub>ELPD</sub>"), matches("elpd")) %>% 
# 	tab_spanner(md("WAIC<sub>*p*</sub>"), matches("_p_")) %>% 
# 	cols_label(
# 		model = "Model",
# 		estimate_elpd_waic = "Estimate",
# 		estimate_waic = "Estimate",
# 		estimate_p_waic = "Estimate",
# 		se_elpd_waic = md("*SE*"),
# 		se_waic = md("*SE*"),
# 		se_p_waic = md("*SE*"),
# 	) %>% 
# 	cols_align("right", "model") %>% 
# 	tab_style(
# 		cell_text(weight = "bold"),
# 		cells_column_spanners()
# 	) %>% 
# 	tab_style(
# 		cell_text(style = "italic"),
# 		cells_column_labels()
# 	)
# 
# gtsave(model_comparison, here("img", "model_comparison.png"))
# 
# 
# as_raw_html(model_comparison)


```


# Model with total vocabulary

## Fixed effects


```{r fixed_effects_table, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
str_repl <- c(
	
	# cubic terms ----
	"b_Itime_bin_centerE3:trial_typecognate_noncognate:lpLPMonvs.Bil" = 
		"Trial type (C vs. NC) \u00d7 Group",
	
	"b_Itime_bin_centerE3:trial_typerelated_unrelated:lpLPMonvs.Bil" = 
		"Trial type (U vs. C+NC) \u00d7 Group",
	
	"b_Itime_bin_centerE3:lpLPMonvs.Bil" =
		"Group (ML vs. BL)",
	
	"b_Itime_bin_centerE3:trial_typecognate_noncognate" = 
		"Trial type (C vs. NC)",
	
	"b_Itime_bin_centerE3:trial_typerelated_unrelated" = 
		"Trial type (U vs. C+NC)",
	
	"b_Itime_bin_centerE3" = 
		"Main effect",
	
	# quadratic terms ----
	"b_Itime_bin_centerE2:trial_typecognate_noncognate:lpLPMonvs.Bil" = 
		"Trial type (C vs. NC) \u00d7 Group",
	
	"b_Itime_bin_centerE2:trial_typerelated_unrelated:lpLPMonvs.Bil" = 
		"Trial type (U vs. C+NC) \u00d7 Group",
	
	"b_Itime_bin_centerE2:lpLPMonvs.Bil" =
		"Group (ML vs. BL)",
	
	"b_Itime_bin_centerE2:trial_typecognate_noncognate" = 
		"Trial type (C vs. NC)",
	
	"b_Itime_bin_centerE2:trial_typerelated_unrelated" = 
		"Trial type (U vs. C+NC)",
	
	"b_Itime_bin_centerE2" = 
		"Main effect",
	
	# linear terms ----
	"b_time_bin_center:trial_typecognate_noncognate:lpLPMonvs.Bil" = 
		"Trial type (C vs. NC) \u00d7 Group",
	
	"b_time_bin_center:trial_typerelated_unrelated:lpLPMonvs.Bil" = 
		"Trial type (U vs. C+NC) \u00d7 Group",
	
	"b_time_bin_center:lpLPMonvs.Bil" =
		"Group (ML vs. BL)",
	
	"b_time_bin_center:trial_typecognate_noncognate" = 
		"Trial type (C vs. NC)",
	
	"b_time_bin_center:trial_typerelated_unrelated" = 
		"Trial type (U vs. C+NC)",
	
	"b_time_bin_center" = 
		"Main effect",
	
	# marginal terms ----
	"b_trial_typecognate_noncognate:lpLPMonvs.Bil" = 
		"Trial type (C vs. NC) \u00d7 Group",
	
	"b_trial_typerelated_unrelated:lpLPMonvs.Bil" = 
		"Trial type (U vs. C+NC) \u00d7 Group",
	
	"b_lpLPMonvs.Bil" = 
		"Group (ML vs. BL)",
	
	"b_trial_typecognate_noncognate" =
		"Trial type (C vs. NC)",
	
	"b_trial_typerelated_unrelated" =
		"Trial type (U vs. C+NC)",
	
	"b_Intercept" = "Intercept",
	
	# sigma
	"sigma" = "Sigma"
)



draws <- gather_draws(fit_2, `b_.*`, `sigma`, regex = TRUE) %>% 
	mutate(
		.value = ifelse(.variable=="sigma", inv_logit(.value), .value),
		.variable_name = str_replace_all(.variable, str_repl),
		type = case_when(
			str_detect(.variable, "E2") ~ "Quadratic time",
			str_detect(.variable, "E3") ~ "Cubic time",
			str_detect(.variable, "time_bin") ~ "Linear time",
			str_detect(.variable, "sigma") ~ "Error",
			TRUE ~ "Main effects"
		) %>% 
			factor(levels = c("Main effects", "Linear time", "Quadratic time", "Cubic time", "Error"), ordered = TRUE)
	)

draws %>% 
	group_by(.variable, .variable_name, type) %>% 
	mean_qi() %>% 
	select(type, .variable_name, .value, .lower, .upper) %>% 
	gt(rowname_col = ".variable", groupname_col = "type")  %>% 
	fmt_percent(3) %>%
	fmt_number(4:5, scale_by = 100) %>% 
	cols_merge(c(".lower", ".upper"), pattern = "[{1}, {2}]") %>% 
	cols_label(
		.variable_name = md("**Predictor**"),
		.value = md("**Mean**"),
		.lower = md("**95% CrI**")
	) %>% 
	tab_style(
		cell_text(weight = "bold", style = "italic"),
		cells_row_groups()
	) 
as_raw_html()
```


```{r main_effects_plot, echo=FALSE, message=FALSE, warning=FALSE, fig.height=10, fig.width=10}

draws %>% 
	filter(str_detect(.variable, "Intercept")) %>% 
	ggplot(aes(.value, .variable_name)) +
	geom_vline(xintercept = 0.5, colour = "black", linetype = "dashed") +
	stat_pointinterval() +
	labs(
		x = "Value", 
		y = "Variable", 
		fill = "CrI", 
		title = "Intercept",
		alpha = "CrI"
	) +
	guides(fill = "none", color = "none") +
	scale_fill_brewer(direction = -1, na.translate = FALSE) +
	scale_x_continuous(labels = percent, limits = c(0, 1)) +
	theme(
		axis.title.y = element_blank()
	)


draws %>% 
	filter(
		str_detect(
			.variable, 
			"sigma|sd|time_bin", 
			negate = TRUE
		)
	) %>% 
	ggplot() +
	aes(
		x = .value, 
		y = .variable_name,
		colour = .variable_name
	) +
	geom_vline(
		xintercept = 0,
		colour = "black", 
		linetype = "dashed"
	) +
	stat_pointinterval() +
	labs(
		x = "Value", 
		y = "Variable", 
		fill = "CrI", 
		alpha = "CrI",
		title = "Main effects"
	) +
	guides(
		fill = "none", 
		color = "none"
	) +
	scale_color_d3() +
	scale_x_continuous(
		labels = percent,
		limits = c(-0.45, 1)
	) +
	theme(
		axis.title.y = element_blank()
	)

```

```{r main_effects_plot_time, echo=FALSE, message=FALSE, warning=FALSE, fig.height=10, fig.width=10}

draws %>%
	filter(str_detect(.variable, "time_bin")) %>% 
	mutate(
		.variable_name = factor(
			.variable_name,
			levels = c(
				"Main effect",
				"Group (ML vs. BL)",
				"Trial type (U vs. C+NC)",
				"Trial type (C vs. NC)",
				"Trial type (U vs. C+NC) \u00d7 Group",
				"Trial type (C vs. NC) \u00d7 Group"
			)
		)
	) %>% 
	ggplot() +
	aes(
		x = .value, 
		y = fct_rev(.variable_name),
		colour = type
	) +
	facet_wrap(
		~type, 
		scales = "free_x"
	) +
	geom_vline(
		xintercept = 0,
		colour = "black",
		linetype = "dashed"
	) +
	stat_pointinterval(
		point_size = 1.5
	) +
	labs(
		x = "Value", 
		y = "Variable", 
		fill = "CrI", 
		alpha = "CrI",
		title = "Polynomial effects"
	) +
	scale_color_d3() +
	guides(fill = "none", color = "none") +
	scale_x_continuous(labels = ~percent(., accuracy = 0.1)) +
	theme(
		axis.title.y = element_blank(),
		axis.text.y = element_text(hjust = 1),
		panel.border = element_rect(fill = NA, colour = "grey", size = 0.75),
		panel.grid.major.x = element_line(colour = "grey", linetype = "dotted")
	)

ggsave(here("img", "results_polynomial_terms.png"))
```

```{r main_effects_plot_sigma, echo=FALSE, message=FALSE, warning=FALSE, fig.height=10, fig.width=10}

draws %>% 
	filter(str_detect(.variable, "sigma")) %>% 
	ggplot(
		aes(.value, 
			.variable_name
		)
	) +
	stat_pointinterval() +
	labs(
		x = "Value", 
		y = "Variable", 
		alpha = "CrI",
		fill = "CrI", 
		title = "Error"
	) +
	guides(fill = "none", color = "none") +
	scale_x_continuous(labels = percent, limits = c(0.7, 0.72)) +
	theme(
		axis.title.y = element_blank()
	) 


```


## Random effects


```{r random_effects_participant, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE, fig.height=8, fig.height=4}

corr_mat <- VarCorr(fit_3, summary = TRUE)$participant$cor 
corr_names <- rownames(VarCorr(fit_3, summary = TRUE)$participant$cor)

corr_mat <- corr_mat %>% 
	as_tibble() %>% 
	select(matches("Estimate")) %>% 
	rename_all(str_remove, "Estimate.") %>% 
	mutate(term1 = corr_names)

corr_mat[lower.tri(corr_mat)] <- NA

corr_data <- corr_mat %>% 
	as.data.frame() %>% 
	pivot_longer(
		-term1, 
		names_to = "term2",
		values_to = ".value"
	) %>% 
	drop_na(.value)


corr_data %>% 
	mutate_at(vars(term1, term2), ~paste0("b_", .)) %>% 
	mutate_at(vars(term1, term2), str_replace_all, str_repl) %>% 
	mutate(
		.value_label = case_when(term1==term2 ~ NA_character_, TRUE ~ printnum(.value, gt1 = FALSE)),
		.value = case_when(term1==term2 ~ NA_real_, TRUE ~ .value)
	) %>% 
	filter(term1 != "PTHN Ã— Levenshtein", term2 != "Intercept") %>% 
	ggplot(aes(fct_inorder(term1), fct_rev(fct_inorder(term2)), fill = .value)) +
	geom_tile(na.rm = TRUE) +
	geom_text(aes(label = .value_label), size = 3, na.rm = TRUE) +
	labs(
		x = "Term 1", 
		y = "Term 2", 
		fill = "Posterior\ncorrelation",
		title = "By participant"
	) +
	scale_fill_gradient2(
		low = "#04bf78", mid = "white", high = "#FFC20A", 
		na.value = "white", limits = c(-0.4, 0.4)
	) +
	scale_x_discrete() +
	coord_equal() +
	theme(
		panel.grid = element_blank(),
		legend.position = "top",
		legend.direction = "horizontal",
		legend.key.height = unit(0.1, "cm"),
		legend.key.width = unit(0.3, "cm"),
		legend.justification = c(1, 1),
		legend.title = element_blank(),
		legend.text = element_text(size = 5),
		axis.title.x = element_blank(),
		axis.title.y = element_blank(),
		axis.ticks = element_blank(),
		axis.text.x = element_text(size = 7, angle = 90, hjust = 1, vjust = 1)
	)

```




## Marginal means

### Prior predictions (before seeing the data)

```{r gaze_time_prior, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
sample_size <- participants %>% 
	filter(valid_participant) %>% 
	count(lp, vocab_size_total_center)

n <- expand_grid(
	lp = c("Monolingual", "Bilingual"),
	vocab_size_l1_center = c(-1, 1),
	trial_type = unique(gaze$trial_type),
	time_bin_center = seq(min(gaze$time_bin_center), max(gaze$time_bin_center), 0.1)
)

m <- epred_draws(fit_l1_prior, newdata = n, ndraws = 50, re_formula = NA) %>% 
	mutate(
		.value = logit_to_prob(.epred),
		vocab_size_l1_center = ifelse(
			vocab_size_l1_center==-1, 
			"Low vocabulary size (-1 SD)",
			"High vocabulary size (+1 SD)"
		)
	)

ggplot(m, aes(time_bin_center, .value)) +
	facet_grid(fct_rev(lp)~vocab_size_l1_center) +
	geom_hline(yintercept = 0.5, colour = "black") +
	geom_line(
		aes(group = interaction(vocab_size_l1_center, trial_type, lp, .draw),
			colour = trial_type),
		alpha = 0.5, size = 0.65
	) +
	
	labs(x = "Time bin (100 ms)", y = "Expected posterior mean PTLT", colour = "Trial type",
		 fill = "Trial type", shape = "Trial type", linetype = "Trial type") +
	scale_color_futurama() +
	scale_x_continuous(
		breaks = min(gaze$time_bin_center):max(gaze$time_bin_center), 
		labels = 1:20
	) +
	scale_y_continuous(
		limits = c(0, 1), 
		labels = percent
	) + 
	theme_minimal() +
	theme(
		legend.position = "top",
		legend.title = element_blank(),
		axis.text.x = element_text(size = 7),
		panel.grid.major.x = element_blank(),
		panel.grid.minor.x = element_blank(),
		panel.background = element_rect(fill = "white", colour = NA),
		plot.background = element_rect(fill = "white", colour = NA)
	) 

```


### Posterior predictions (after seeing the data)

```{r gaze_time, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}

sample_size <- participants %>% 
	filter(valid_participant) %>% 
	count(lp, age_group, vocab_size_total_center)

observed <- fit_3$data %>% 
	group_by(time_bin_center, trial_type, lp, age_group) %>% 
	summarise(
		.value = logit_to_prob(mean(logit, na.rm = TRUE)),
		n = n(),
		.groups = "drop"
	) %>% 
	mutate(.value_se = sd(.value, na.rm = TRUE) / sqrt(n))

nd <- expand_grid(
	lp = c("Monolingual", "Bilingual"),
	trial_type = unique(gaze$trial_type),
	age_group = unique(gaze$age_group),
	time_bin_center = seq(
		min(gaze$time_bin_center), 
		max(gaze$time_bin_center), 
		0.1
	)
)

m <- epred_draws(
	object = fit_3, 
	newdata = nd, 
	# ndraws = 20,
	re_formula = NA
) %>% 
	mutate(
		.value = logit_to_prob(.epred)
	)

m %>% 
	ggplot() +
	aes(
		x = time_bin_center, 
		y = .value,
		colour = trial_type,
		fill = trial_type,
		linetype = trial_type,
		shape = trial_type
	) +
	facet_wrap(
		fct_rev(lp)~age_group,
		scales = "free",
		labeller = label_wrap_gen(multi_line = FALSE)
	) +
	geom_hline(
		yintercept = 0.5,
		colour = "black"
	) +
	# geom_line(
	# 	aes(group = interaction(trial_type, lp, .draw),
	# 		colour = trial_type),
	# 	alpha = 0.5, size = 0.65
	# ) +
	stat_summary(
		fun.data = mean_qi,
		geom = "ribbon",
		colour = NA,
		alpha = 0.25
	) +
	stat_summary(
		fun = mean,
		geom = "line",
		size = 0.75
	) +
	geom_text(
		data = sample_size,
		aes(
			x = min(gaze$time_bin_center),
			y = 1,
			label = paste0("N = ", n)
		),
		colour = "black",
		hjust = 0,
		vjust = 1,
		inherit.aes = FALSE
	) +
	geom_point(
		data = observed,
		size = 1.5
	) +
	labs(
		x = "Time from target-distractor onset (ms)", 
		y = "Posterior mean PTLT",
		colour = "Trial type",
		fill = "Trial type", 
		shape = "Trial type",
		linetype = "Trial type"
	) +
	scale_color_d3() +
	scale_fill_d3() +
	scale_x_continuous(
		breaks = seq(
			min(gaze$time_bin_center),
			max(gaze$time_bin_center),
			len = 7
		),
		labels = format(
			100*(seq(3, 18, 3)), 
			big.mark = ",", trim = TRUE
		)
	) +
	scale_y_continuous(
		limits = c(0, 1),
		labels = percent
	) + 
	theme_custom() +
	theme(
		legend.position = "top",
		legend.title = element_blank(),
		axis.text.x = element_text(face = "plain"),
		axis.text.y = element_text(face = "plain"),
		panel.grid.major.x = element_blank(),
		panel.grid.minor.x = element_blank(),
		panel.background = element_rect(
			fill = NA, 
			colour = NA
		),
		plot.background = element_rect(
			fill = "white",
			colour = NA
		)
	) 


ggsave(
	here("img", "predictions.png"),
	dpi = 2000,
	height = 7,
	width = 12
)

```

```{r gaze_time_observed, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}

sample_size <- participants %>% 
	filter(valid_participant) %>% 
	count(lp, age_group)

observed <- fit_3$data %>% 
	group_by(time_bin_center, trial_type, lp, age_group) %>% 
	summarise(
		.value = logit_to_prob(mean(logit, na.rm = TRUE)),
		n = n(),
		.groups = "drop"
	) %>% 
	mutate(.value_se = sd(.value, na.rm = TRUE) / sqrt(n))

nd <- expand_grid(
	lp = c("Monolingual", "Bilingual"),
	trial_type = unique(gaze$trial_type),
	age_group = unique(gaze$age_group),
	time_bin_center = seq(min(gaze$time_bin_center), max(gaze$time_bin_center), 0.1)
)

m <- epred_draws(
	object = fit_3, 
	newdata = nd, 
	# ndraws = 20,
	re_formula = NA
) %>% 
	mutate(
		.value = logit_to_prob(.epred)
	)

m %>% 
	ggplot() +
	aes(
		x = time_bin_center, 
		y = .value,
		colour = trial_type,
		fill = trial_type,
		linetype = trial_type,
		shape = trial_type
	) +
	facet_grid(lp~age_group) +
	geom_hline(
		yintercept = 0.5,
		colour = "black"
	) +
	geom_line(
		data = observed
	) +
	geom_point(
		data = observed,
		size = 3
	) +
	geom_text(
		data = sample_size,
		aes(
			x = min(gaze$time_bin_center),
			y = 1,
			label = paste0("N = ", n)
		),
		colour = "black",
		hjust = 0,
		vjust = 1,
		inherit.aes = FALSE
	) +
	labs(
		x = "Time bin (100 ms)", 
		y = "Expected posterior mean PTLT",
		colour = "Trial type",
		fill = "Trial type", 
		shape = "Trial type",
		linetype = "Trial type"
	) +
	scale_color_d3() +
	scale_fill_d3() +
	scale_x_continuous(
		breaks = seq(
			min(gaze$time_bin_center),
			max(gaze$time_bin_center),
			len = 5
		),
		labels = format(
			100*(seq(0, 20, 5)), 
			big.mark = ","
		)
	) +
	scale_y_continuous(
		limits = c(0, 1),
		labels = percent
	) + 
	theme(
		legend.position = "top",
		legend.title = element_blank(),
		panel.grid.major.x = element_blank(),
		panel.grid.minor.x = element_blank(),
		panel.background = element_rect(fill = "white", colour = NA),
		plot.background = element_rect(fill = "white", colour = NA)
	) 

ggsave(here("img", "predictions_observed.png"))

```


## Marginal means {.tabset }

```{r gaze_marginal, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}

m <- emmeans(fit_3, ~trial_type | age_group, by = "lp", epred = TRUE) 

m_draws <- gather_emmeans_draws(m) %>% 
	as_tibble() %>% 
	mutate_at(vars(.value), function(x) ifelse(x < 0, 0, x)) %>% 
	mutate_at(vars(.value), function(x) ifelse(x > 1, 1, x))

m_draws %>% 
	ggplot() +
	aes(
		x = .value, 
		y = trial_type, 
		fill = trial_type
	) +
	facet_grid(lp~age_group) +
	stat_slab(
		aes(
			alpha = stat(
				cut_cdf_qi(
					cdf, 
					.width = c(.95, .8, .5), 
					labels = percent_format()
				)
			)
		),
		position = position_nudge(y = 0.05),
		color = "white"
	) +
	stat_pointinterval(
		color = "black"
	) +
	labs(
		x = "Expected posterior mean PTLT",
		y = "Trial type",
		colour = "Trial type", 
		fill = "Trial type",
		alpha = "CrI"
	) +
	guides(
		color = "none",
		fill = "none"
	) +
	scale_alpha_discrete(
		range = c(0.8, 0.2),
		na.translate = FALSE
	) +
	scale_x_continuous(
		limits = c(0, 1),
		labels = percent
	)  +
	theme(
		axis.title.y = element_blank(),
		legend.position = "right",
		panel.grid.major.x = element_line(colour = "grey", linetype = "dotted"),
		panel.background = element_rect(fill = NA, colour = "grey")
	)


```


# Model with L1 vocabulary


## Fixed effects


```{r fixed_effects_table, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
str_repl <- c(
	
	# 3-way interactions
	"b_time_bin_center:trial_typePrimeNCvs.C:lpLPMonvs.Bil:vocab_size_l1_center" = 
		"Trial type (C vs. NC) \u00d7 Group \u00d7 Vocab (L1)",
	"b_time_bin_center:trial_typePrimeUvs.CPNC:lpLPMonvs.Bil:vocab_size_l1_center" = 
		"Trial type (U vs. C+NC) \u00d7 Group \u00d7 Vocab (L1)",
	
	"b_Itime_bin_centerE2:trial_typePrimeNCvs.C:lpLPMonvs.Bil:vocab_size_l1_center" = 
		"Trial type (C vs. NC) \u00d7 Group \u00d7 Vocab (L1)",
	"b_Itime_bin_centerE2:trial_typePrimeUvs.CPNC:lpLPMonvs.Bil:vocab_size_l1_center" =
		"Trial type (U vs. C+NC) \u00d7 Group \u00d7 Vocab (L1)",
	
	"b_Itime_bin_centerE3:trial_typePrimeNCvs.C:lpLPMonvs.Bil:vocab_size_l1_center" = 
		"Trial type (C vs. NC) \u00d7 Group \u00d7 Vocab (L1)",
	"b_Itime_bin_centerE3:trial_typePrimeUvs.CPNC:lpLPMonvs.Bil:vocab_size_l1_center" =
		"Trial type (U vs. C+NC) \u00d7 Group \u00d7 Vocab (L1)",
	
	# 2-way interactions
	"b_time_bin_center:trial_typePrimeUvs.CPNC:vocab_size_l1_center" = 
		"Trial type (U vs. C+NC) \u00d7 Vocab (L1)",
	"b_time_bin_center:trial_typePrimeNCvs.C:vocab_size_l1_center" = 
		"Trial type (C vs. NC) \u00d7 Vocab (L1)",
	
	"b_time_bin_center:trial_typePrimeUvs.CPNC:lpLPMonvs.Bil" = 
		"Trial type (U vs. C+NC) \u00d7 Group",
	"b_time_bin_center:trial_typePrimeNCvs.C:lpLPMonvs.Bil" = 
		"Trial type (C vs. NC) \u00d7 Group",
	
	"b_time_bin_center:trial_typePrimeUvs.CPNC:vocab_size_l1_center" = 
		"Trial type (U vs. C+NC) \u00d7 Vocab (L1)",
	"b_time_bin_center:trial_typePrimeNCvs.C:vocab_size_l1_center" =
		"Trial type (C vs. NC) \u00d7 Vocab (L1)",
	
	"b_time_bin_center:trial_typePrimeUvs.CPNC:lpLPMonvs.Bil" =
		"Trial type (U vs. C+NC) \u00d7 Group",  
	"b_time_bin_center:lpLPMonvs.Bil:vocab_size_l1_center" =
		"Group \u00d7 Vocab (L1)",
	
	"b_Itime_bin_centerE2:trial_typePrimeUvs.CPNC:vocab_size_l1_center" = 
		"Trial type (U vs. C+NC) \u00d7 Vocab (L1)",
	"b_Itime_bin_centerE2:trial_typePrimeNCvs.C:vocab_size_l1_center" = 
		"Trial type (C vs. NC) \u00d7 Vocab (L1)",
	
	"b_Itime_bin_centerE2:trial_typePrimeUvs.CPNC:lpLPMonvs.Bil" = 
		"Trial type (U vs. C+NC) \u00d7 Group",
	"b_Itime_bin_centerE2:trial_typePrimeNCvs.C:lpLPMonvs.Bil" =
		"Trial type (C vs. NC) \u00d7 Group",
	
	"b_Itime_bin_centerE2:trial_typePrimeUvs.CPNC:vocab_size_l1_center" = 
		"Trial type (U vs. C+NC) \u00d7 Vocab (L1)",
	"b_Itime_bin_centerE2:trial_typePrimeNCvs.C:vocab_size_l1_center" = 
		"Trial type (C vs. NC) \u00d7 Vocab (L1)",
	
	"b_Itime_bin_centerE2:trial_typePrimeUvs.CPNC:lpLPMonvs.Bil" = 
		"Trial type (U vs. C+NC) \u00d7 Group",  
	"b_Itime_bin_centerE2:lpLPMonvs.Bil:vocab_size_l1_center" = 
		"Group \u00d7 Vocab (L1)",
	
	"b_Itime_bin_centerE3:trial_typePrimeUvs.CPNC:vocab_size_l1_center" = 
		"Trial type (U vs. C+NC) \u00d7 Vocab (L1)",
	"b_Itime_bin_centerE3:trial_typePrimeNCvs.C:vocab_size_l1_center" = 
		"Trial type (C vs. NC) \u00d7 Vocab (L1)",
	
	"b_Itime_bin_centerE3:trial_typePrimeUvs.CPNC:lpLPMonvs.Bil" = 
		"Trial type (U vs. C+NC) \u00d7 Group",
	"b_Itime_bin_centerE3:trial_typePrimeNCvs.C:lpLPMonvs.Bil" = 
		"Trial type (C vs. NC) \u00d7 Group",
	
	"b_Itime_bin_centerE3:trial_typePrimeUvs.CPNC:vocab_size_l1_center" = 
		"Trial type (U vs. C+NC) \u00d7 Vocab (L1)",
	"b_Itime_bin_centerE3:trial_typePrimeNCvs.C:vocab_size_l1_center" = 
		"Trial type (C vs. NC) \u00d7 Vocab (L1)",
	
	"b_Itime_bin_centerE3:trial_typePrimeUvs.CPNC:lpLPMonvs.Bil" = 
		"Trial type (U vs. C+NC) \u00d7 Group",  
	"b_Itime_bin_centerE3:lpLPMonvs.Bil:vocab_size_l1_center" = 
		"Group \u00d7 Vocab (L1)",
	
	
	# main effects (linear)
	"b_time_bin_center:trial_typePrimeUvs.CPNC" =
		"Trial type (U vs. C+NC)",
	"b_time_bin_center:trial_typePrimeNCvs.C" = 
		"Trial type (C vs. NC)",
	"b_Itime_bin_centerE2:trial_typePrimeUvs.CPNC" = 
		"Trial type (U vs. C+NC)",
	"b_Itime_bin_centerE2:trial_typePrimeNCvs.C" = 
		"Trial type (C vs. NC)",
	"b_Itime_bin_centerE3:trial_typePrimeUvs.CPNC" = 
		"Trial type (U vs. C+NC)",
	"b_Itime_bin_centerE3:trial_typePrimeNCvs.C" = 
		"Trial type (C vs. NC)",
	
	"b_time_bin_center:lpLPMonvs.Bil" = 
		"Group (Mon. vs. Bil.)",
	"b_Itime_bin_centerE2:lpLPMonvs.Bil" = 
		"Group (Mon. vs. Bil.)",
	"b_Itime_bin_centerE3:lpLPMonvs.Bil" = 
		"Group (Mon. vs. Bil.)",
	
	"b_time_bin_center:vocab_size_l1_center" = 
		"Vocab. (L1, +1 SD)",
	"b_Itime_bin_centerE2:vocab_size_l1_center" = 
		"Vocab. (L1, +1 SD)",
	"b_Itime_bin_centerE3:vocab_size_l1_center" = 
		"Vocab. (L1, +1 SD)",
	
	
	# 3-way interaction linear effects
	"b_trial_typePrimeUvs.CPNC:lpLPMonvs.Bil:vocab_size_l1_center" =
		"Trial type (U vs. C+NC) \u00d7 Group \u00d7 Vocab. (L1, +1 SD)",
	"b_trial_typePrimeNCvs.C:lpLPMonvs.Bil:vocab_size_l1_center" =
		"Trial type (C vs. NC) \u00d7 Group \u00d7 Vocab. (L1, +1 SD)",
	
	# 2-way interaction linear effects
	"b_trial_typePrimeUvs.CPNC:lpLPMonvs.Bil" = 
		"Trial type (U vs. C+NC) \u00d7 Group",
	"b_trial_typePrimeNCvs.C:lpLPMonvs.Bil" = 
		"Trial type (C vs. NC) \u00d7 Group",
	
	"b_trial_typePrimeUvs.CPNC:vocab_size_l1_center" = 
		"Trial type (U vs. C+NC) \u00d7 Vocab. (L1, +1 SD)",
	"b_trial_typePrimeNCvs.C:vocab_size_l1_center" = 
		"Trial type (C vs. NC) \u00d7 Vocab. (L1, +1 SD)",
	
	
	"b_lpLPMonvs.Bil:vocab_size_l1_center" =
		"Group \u00d7 Vocab. (L1, +1 SD)",
	
	"b_Itime_bin_centerE3:trial_typePrimeUvs.CPNC" =
		"Trial type (U vs. C+NC)",
	"b_Itime_bin_centerE3:trial_typePrimeNCvs.C" =
		"Trial type (C vs. NC)",
	
	"b_Itime_bin_centerE3:lpLPMonvs.Bil" = 
		"Group (Mon. vs. Bil.)",
	
	# main linear effects
	"b_Intercept" = "Intercept",
	"b_Itime_bin_centerE2" = "Time bin 2",
	"b_Itime_bin_centerE3" = "Time bin 3",
	"b_time_bin_center" = "Time bin",
	"b_vocab_size_l1_center" = "Vocab. (L1, +1 SD)",
	
	"b_trial_typePrimeUvs.CPNC" = "Trial type (U vs. C+NC)",
	"b_trial_typePrimeNCvs.C" = "Trial type (C vs. NC)",
	"b_lpLPMonvs.Bil" = "Group (Mon. vs. Bil.)",
	
	# sigma
	"sigma" = "Sigma"
)



draws <- gather_draws(fit_l1_4, `b_.*`, `sigma`, regex = TRUE) %>% 
	mutate(
		.value = ifelse(.variable=="sigma", inv_logit(.value), .value),
		.variable_name = str_replace_all(.variable, str_repl),
		type = case_when(
			str_detect(.variable, "E2") ~ "Quadratic time",
			str_detect(.variable, "E3") ~ "Cubic time",
			str_detect(.variable, "time_bin") ~ "Linear time",
			str_detect(.variable, "sigma") ~ "Error",
			TRUE ~ "Main effects"
		) %>% 
			factor(
				levels = c(
					"Main effects",
					"Linear time", 
					"Quadratic time",
					"Cubic time", 
					"Error"
				), 
				ordered = TRUE
			)
	)

draws %>% 
	group_by(.variable, .variable_name, type) %>% 
	mean_qi() %>% 
	select(type, .variable_name, .value, .lower, .upper) %>% 
	gt(rowname_col = ".variable", groupname_col = "type")  %>% 
	fmt_percent(3) %>%
	fmt_number(4:5, scale_by = 100) %>% 
	cols_merge(c(".lower", ".upper"), pattern = "[{1}, {2}]") %>% 
	cols_label(
		.variable_name = md("**Predictor**"),
		.value = md("**Mean**"),
		.lower = md("**95% CrI**")
	) %>% 
	tab_style(
		cell_text(weight = "bold", style = "italic"),
		cells_row_groups()
	) %>%
	as_raw_html()
```


```{r main_effects_plot, echo=FALSE, message=FALSE, warning=FALSE, fig.height=10, fig.width=10}

draws_intercept <- draws %>% 
	filter(str_detect(.variable, "Intercept")) %>% 
	ggplot(aes(.value, .variable_name)) +
	geom_vline(xintercept = 0.5, colour = "black", linetype = "dashed") +
	stat_slab(
		aes(alpha = stat(cut_cdf_qi(cdf, .width = c(.95, .8, .5), labels = percent_format()))),
		size = 0.5,
		color = "#FF6F00FF",
		fill = "#FF6F00FF"
	) +
	labs(
		x = "Value", 
		y = "Variable", 
		fill = "CrI", 
		title = "Intercept",
		alpha = "CrI"
	) +
	guides(fill = "none", color = "none") +
	scale_alpha_discrete(range = c(0.8, 0.2), na.translate = FALSE) +
	scale_fill_brewer(direction = -1, na.translate = FALSE) +
	scale_x_continuous(labels = percent, limits = c(0, 1)) +
	theme(
		panel.grid.major.y = element_blank()
	)

ggsave(here("img", "posterior_intercept_l1.png"), draws_intercept, height = 2, width = 7)

draws_predictors <- draws %>% 
	filter(str_detect(.variable, "Intercept|sigma|sd|time_bin", negate = TRUE)) %>% 
	ggplot(aes(.value, .variable_name)) +
	geom_vline(xintercept = 0, colour = "black", linetype = "dashed") +
	stat_slab(
		aes(alpha = stat(cut_cdf_qi(cdf, .width = c(.95, .8, .5), labels = percent_format()))),
		size = 0.5, 
		color = "#C71000FF", 
		fill = "#C71000FF"
	) +
	labs(
		x = "Value", 
		y = "Variable", 
		fill = "CrI", 
		alpha = "CrI",
		title = "Main effects"
	) +
	guides(fill = "none", color = "none") +
	scale_alpha_discrete(range = c(0.8, 0.2), na.translate = FALSE) +
	scale_fill_brewer(direction = -1, na.translate = FALSE) +
	scale_x_continuous(labels = percent, limits = c(-0.2, 0.2)) +
	theme(
		panel.grid.major.y = element_blank()
	)

ggsave(here("img", "posterior_predictors_l1.png"), draws_predictors, height = 7, width = 7)


draws_time <- draws %>%
	filter(str_detect(.variable, "time_bin")) %>% 
	ggplot(aes(.value, .variable_name)) +
	facet_wrap(~type, scales = "free_x") +
	geom_vline(xintercept = 0, colour = "black", linetype = "dashed") +
	# stat_slab(
	# 	aes(alpha = stat(cut_cdf_qi(cdf, .width = c(.95, .8, .5), labels = percent_format()))),
	# 	size = 0.5, 
	# 	color = "#008EA0FF", 
	# 	fill = "#008EA0FF"
	# ) +
	stat_pointinterval(
		color = "#008EA0FF",
		fill = "#008EA0FF",
		point_size = 1.5
	) +
	labs(
		x = "Value", 
		y = "Variable", 
		fill = "CrI", 
		alpha = "CrI",
		title = "Polynomial effects"
	) +
	guides(fill = "none", color = "none") +
	scale_alpha_discrete(range = c(0.8, 0.2), na.translate = FALSE) +
	scale_fill_brewer(direction = -1, na.translate = FALSE) +
	scale_x_continuous(labels = percent) +
	theme(
		panel.grid.major.y = element_blank(),
		panel.border = element_rect(fill = NA, colour = "grey"),
		axis.title = element_blank()
	)

ggsave(here("img", "posterior_poly_l1.png"), draws_time, height = 7, width = 9)


draws_sigma <- draws %>% 
	filter(str_detect(.variable, "sigma")) %>% 
	ggplot(aes(.value, .variable_name)) +
	stat_slab(
		aes(alpha = stat(cut_cdf_qi(cdf, .width = c(.95, .8, .5), labels = percent_format()))),
		size = 0.5, 
		color = "#8A4198FF", 
		fill = "#8A4198FF"
	) +
	labs(
		x = "Value", 
		y = "Variable", 
		alpha = "CrI",
		fill = "CrI", 
		title = "Error"
	) +
	guides(fill = "none", color = "none") +
	scale_alpha_discrete(range = c(0.8, 0.2), na.translate = FALSE) +
	scale_fill_brewer(direction = -1, na.translate = FALSE) +
	scale_x_continuous(labels = percent, limits = c(0.92, 0.96)) +
	theme(
		panel.grid.major.y = element_blank()
	)

ggsave(here("img", "posterior_sigma_l1.png"), draws_sigma, height = 2, width = 7)


((draws_intercept / draws_sigma / guide_area()) | draws_predictors) /
	draws_time + 
	plot_layout(heights = c(0.5, 0.5)) &
	guides(fill = "none", color = "none") &
	theme(
		panel.background = element_rect(fill = NA, colour = "grey"),
		axis.text.y = element_text(size = 7),
		axis.text.x = element_text(size = 7),
		axis.title = element_blank(),
		legend.position = c(1, 1.2),
		legend.direction = "horizontal",
		legend.justification = "right",
		legend.key.size = unit(0.35, "cm"),
		legend.text = element_text(size = 7),
		legend.title = element_text(size = 7),
		panel.grid.major.y = element_blank()
	)

```


## Random effects


```{r random_effects_participant, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE, fig.height=8,fig.height=4}

corr_mat <- VarCorr(fit_l1_4, summary = TRUE)$participant$cor 
corr_names <- rownames(VarCorr(fit_l1_4, summary = TRUE)$participant$cor)

corr_mat <- corr_mat %>% 
	as_tibble() %>% 
	select(matches("Estimate")) %>% 
	rename_all(str_remove, "Estimate.") %>% 
	mutate(term1 = corr_names)

corr_mat[lower.tri(corr_mat)] <- NA

corr_data <- corr_mat %>% 
	as.data.frame() %>% 
	pivot_longer(-term1, names_to = "term2", values_to = ".value") %>% 
	drop_na(.value)

post_cors_participant <- corr_data %>% 
	mutate_at(vars(term1, term2), ~paste0("b_", .)) %>% 
	mutate_at(vars(term1, term2), str_replace_all, str_repl) %>% 
	mutate(
		.value_label = case_when(term1==term2 ~ NA_character_, TRUE ~ printnum(.value, gt1 = FALSE)),
		.value = case_when(term1==term2 ~ NA_real_, TRUE ~ .value)
	) %>% 
	filter(term1 != "PTHN Ã— Levenshtein", term2 != "Intercept") %>% 
	ggplot(aes(fct_inorder(term1), fct_rev(fct_inorder(term2)), fill = .value)) +
	geom_tile(na.rm = TRUE) +
	geom_text(aes(label = .value_label), size = 3, na.rm = TRUE) +
	labs(
		x = "Term 1", 
		y = "Term 2", 
		fill = "Posterior\ncorrelation",
		title = "By participant"
	) +
	scale_fill_gradient2(
		low = "#04bf78", mid = "white", high = "#FFC20A", 
		na.value = "white", limits = c(-0.4, 0.4)
	) +
	scale_x_discrete() +
	coord_equal()  +
	theme(
		axis.text.y = element_text(size = 7)
	)


# correlations by item
corr_mat <- VarCorr(fit_l1_4, summary = TRUE)$target$cor 
corr_names <- rownames(VarCorr(fit_l1_4, summary = TRUE)$target$cor)

corr_mat <- corr_mat %>% 
	as_tibble() %>% 
	select(matches("Estimate")) %>% 
	rename_all(str_remove, "Estimate.") %>% 
	mutate(term1 = corr_names)

corr_mat[lower.tri(corr_mat)] <- NA

corr_data <- corr_mat %>% 
	as.data.frame() %>% 
	pivot_longer(-term1, names_to = "term2", values_to = ".value") %>% 
	drop_na(.value)

post_cors_item <- corr_data %>% 
	mutate_at(vars(term1, term2), ~paste0("b_", .)) %>% 
	mutate_at(vars(term1, term2), str_replace_all, str_repl) %>% 
	mutate(
		.value_label = case_when(term1==term2 ~ NA_character_, TRUE ~ printnum(.value, gt1 = FALSE)),
		.value = case_when(term1==term2 ~ NA_real_, TRUE ~ .value)
	) %>% 
	filter(term1 != "PTHN Ã— Levenshtein", term2 != "Intercept") %>% 
	ggplot(aes(fct_inorder(term1), fct_rev(fct_inorder(term2)), fill = .value)) +
	geom_tile(na.rm = TRUE) +
	geom_text(aes(label = .value_label), size = 3, na.rm = TRUE) +
	labs(
		x = "Term 1", y = "Term 2", fill = "Posterior\ncorrelation",
		title = "By item"
	) +
	scale_fill_gradient2(
		low = "#04bf78", mid = "white", high = "#FFC20A", 
		na.value = "white", limits = c(-0.4, 0.4)
	) +
	scale_x_discrete() +
	coord_equal() +
	theme(
		axis.text.y = element_blank()
	)


(post_cors_participant | post_cors_item) &
	plot_layout(guides = "collect") &
	theme(
		panel.grid = element_blank(),
		legend.position = "top",
		legend.direction = "horizontal",
		legend.key.height = unit(0.1, "cm"),
		legend.key.width = unit(0.3, "cm"),
		legend.justification = c(1, 1),
		legend.title = element_blank(),
		legend.text = element_text(size = 5),
		axis.title.x = element_blank(),
		axis.title.y = element_blank(),
		axis.ticks = element_blank(),
		axis.text.x = element_text(size = 7, angle = 90, hjust = 1, vjust = 1)
		
	)

```




## Posterior predictions (after seeing the data)

```{r gaze_time, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
sample_size <- participants %>% 
	filter(valid_participant) %>% 
	count(lp, vocab_size_l1_center)

n <- expand_grid(
	lp = c("Monolingual", "Bilingual"),
	vocab_size_l1_center = c(-1, 1),
	trial_type = unique(gaze$trial_type),
	time_bin_center = seq(min(gaze$time_bin_center), max(gaze$time_bin_center), 0.1)
)

m <- epred_draws(object = fit_l1_4, newdata = n, ndraws = 50, re_formula = NA) %>% 
	mutate(
		.value = logit_to_prob(.epred),
		vocab_size_l1_center = ifelse(
			vocab_size_l1_center==-1, 
			"Low vocabulary size (-1 SD)",
			"High vocabulary size (+1 SD)"
		) %>% 
			factor(levels = c(
				"Low vocabulary size (-1 SD)",
				"High vocabulary size (+1 SD)"
			),
			ordered = TRUE)
	)

ggplot(m, aes(time_bin_center, .value, fill = trial_type, colour = trial_type)) +
	facet_grid(fct_rev(lp)~vocab_size_l1_center) +
	geom_hline(yintercept = 0.5, colour = "black") +
	# geom_line(
	# 	aes(group = interaction(vocab_size_l1_center, trial_type, lp, .draw),
	# 		colour = trial_type),
	# 	alpha = 0.5, size = 0.65
	# ) +
	stat_lineribbon(.width = 0.95, alpha = 0.5, color = NA) +
	stat_lineribbon(.width = 0.95, fill = NA) +
	labs(x = "Time bin (100 ms)", y = "Expected posterior mean PTLT", colour = "Trial type",
		 fill = "Trial type", shape = "Trial type", linetype = "Trial type") +
	scale_color_futurama() +
	scale_fill_futurama() +
	scale_x_continuous(
		breaks = min(gaze$time_bin_center):max(gaze$time_bin_center), 
		labels = 1:20
	) +
	scale_y_continuous(limits = c(0, 1), labels = percent) + 
	theme_minimal() +
	theme(
		text = element_text(size = 15),
		legend.position = "top",
		legend.title = element_blank(),
		axis.text.x = element_text(size = 7),
		axis.text.y = element_text(size = 9),
		panel.grid.major.x = element_blank(),
		panel.grid.minor.x = element_blank(),
		panel.grid.minor.y = element_blank(),
		panel.grid.major.y = element_blank(),
		panel.background = element_rect(fill = "white", colour = NA),
		panel.border = element_rect(fill = NA, colour = "grey"),
		plot.background = element_rect(fill = "white", colour = NA)
	) 

ggsave(here("img", "epreds_l1.jpeg"), dpi = 1000)

```


```{r gaze_matrix, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
sample_size <- participants %>% 
	filter(valid_participant) %>% 
	count(lp, vocab_size_l1_center)

n <- expand_grid(
	lp = c("Monolingual", "Bilingual"),
	vocab_size_l1_center = seq(-2, 2, 0.25),
	trial_type = unique(gaze$trial_type),
	time_bin_center = seq(min(gaze$time_bin_center), max(gaze$time_bin_center), 0.25)
)

m <- epred_draws(object = fit_l1_4, newdata = n, ndraws = 50, re_formula = NA) %>% 
	median_qi() %>%  
	mutate(.value = logit_to_prob(.epred)) 

ggplot(m, aes(time_bin_center, vocab_size_l1_center, fill = .value)) +
	facet_grid(fct_rev(lp)~trial_type) +
	# geom_line(
	# 	aes(group = interaction(vocab_size_l1_center, trial_type, lp, .draw),
	# 		colour = trial_type),
	# 	alpha = 0.5, size = 0.65
	# ) +
	geom_raster(interpolate = TRUE) +
	labs(
		x = "Time bin (100 ms)", 
		y = "Vocabulary size (SD)", 
		colour = "Expected posterior mean PTLT",
		fill = "Expected posterior mean PTLT",
		shape = "Expected posterior mean PTLT",
		linetype = "Expected posterior mean PTLT"
	) +
	scale_fill_viridis_c(labels = percent, option = "plasma") +
	scale_x_continuous(
		breaks = min(gaze$time_bin_center):max(gaze$time_bin_center), 
		labels = 1:20
	) +
	theme_minimal() +
	theme(
		text = element_text(size = 15),
		legend.position = "top",
		legend.text = element_text(size = 9),
		legend.key.width = unit(1, "cm"),
		axis.text.x = element_text(size = 7),
		axis.text.y = element_text(size = 9),
		panel.grid.major.x = element_blank(),
		panel.grid.minor.x = element_blank(),
		panel.grid.minor.y = element_blank(),
		panel.grid.major.y = element_blank(),
		panel.background = element_rect(fill = "white", colour = NA),
		plot.background = element_rect(fill = "white", colour = NA)
	) 

ggsave(here("img", "epreds_l1_3d.jpeg"), dpi = 1000)

```

## Marginal means {.tabset }

```{r gaze_marginal, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}

m <- emmeans(fit_l1_4, ~trial_type | lp, epred = TRUE) 

m_draws <- gather_emmeans_draws(m) %>% 
	as_tibble() %>% 
	mutate_at(vars(.value), function(x) ifelse(x < 0, 0, x)) %>% 
	mutate_at(vars(.value), function(x) ifelse(x > 1, 1, x))

ggplot(m_draws, aes(.value, trial_type, colour = trial_type, fill = trial_type)) +
	facet_wrap(~lp) +
	stat_slab(
		aes(alpha = stat(cut_cdf_qi(cdf, .width = c(.95, .8, .5), labels = percent_format()))),
		position = position_nudge(y = 0.05)
	) +
	stat_pointinterval(
		color = "black",
	) +
	labs(
		x = "Expected posterior mean PTLT", y = "Trial type",
		colour = "Trial type", fill = "Trial type",
		alpha = "CrI"
	) +
	guides(color = "none", fill = "none") +
	scale_alpha_discrete(range = c(0.8, 0.2), na.translate = FALSE) +
	scale_x_continuous(limits = c(0.5, 1), labels = percent)  +
	theme(
		axis.title.y = element_blank(),
		legend.position = "right",
		panel.grid.major.y = element_blank(),
		panel.grid.minor.y = element_blank(),
		panel.grid.minor.x = element_blank(),
		panel.background = element_rect(fill = NA, colour = "grey")
	)

ggsave(here("img", "emmeans_l1.jpeg"), dpi = 1000)


```