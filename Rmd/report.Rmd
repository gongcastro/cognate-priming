---
title: "Report"
output:
  html_document:
    df_print: paged
    toc: true
    toc_depth: 4
    toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = FALSE,
	message = TRUE,
	warning = TRUE, 
	cache.extra = knitr::rand_seed,
	out.width = "100%",
	results = "asis",
	dev.args = list(png = list(type = "cairo"))
)
options(knitr.kable.NA = '-',
		ggplot2.discrete.fill = RColorBrewer::brewer.pal(6, name = "Dark2"),
		ggplot2.discrete.colour = RColorBrewer::brewer.pal(6, name = "Dark2"),
		ggplot2.continuous.fill = RColorBrewer::brewer.pal(6, name = "Dark2"),
		ggplot2.continuous.colour = RColorBrewer::brewer.pal(6, name = "Dark2")
)

```

```{r prepare, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}

# load packages
library(papaja)
library(knitr)
library(tidyverse)
library(bilingualr)
library(lubridate)
library(scales)
library(DiagrammeR)
library(janitor)
library(lme4)
library(broom.mixed)
library(gt)
library(patchwork)
library(htmltools)
library(here)

# create functions
logit_to_prob <- function(x) exp(x) / (1 + exp(x))

theme_custom <- function(){
	theme(
		panel.background = element_rect(fill = "transparent"),
		panel.grid = element_blank(),
		#panel.grid = element_line(colour = "grey", linetype = "dotted"),
		panel.border = element_rect(fill = "transparent", colour = "black"),
		text = element_text(colour = "black", size = 15),
		axis.text = element_text(colour = "black")
	)
}
theme_set(theme_custom())

# load data
gaze <- readRDS(here("Data", "Gaze", "processed.rds"))
attrition <- readRDS(here("Results", "attrition.rds"))
participants <- readRDS(here("Data", "Participants", "participants.rds")) %>% 
	left_join(distinct(attrition, participant, age_group, valid_participant)) %>% 
	drop_na(participant)
fit <- readRDS(here("Results", "fit.rds"))


```


# Methods

## Participants {.tabset .tabpills}

* We collected data from `r length(unique(participants$participant))` participants `r length(unique(participants$participant[participants$location=="Oxford"]))` were tested in Oxford, and `r length(unique(participants$participant[participants$location=="Barcelona"]))` were tested in Barcelona.
* After applying trial- ad participant-level exclusion criteria, the sample comprise data from `r length(unique(participants$participant[participants$valid_participant]))` (`r length(unique(participants$participant[participants$valid_participant & participants$location=="Oxford"]))` tested in Oxford, and `r length(unique(participants$participant[participants$valid_participant & participants$location=="Barcelona"]))` tested in Barcelona), and were included in our analyses.
* `r length(participants$participant[duplicated(participants$participant) & participants$valid_participant])` participants in the final sample were longitudinal (tested in at least one age group). `r length(participants$participant[duplicated(participants$participant) & participants$location=="Oxford" & participants$valid_participant])` longitudinal participants were tested in Oxford and `r length(participants$participant[duplicated(participants$participant) & participants$location=="Barcelona" & participants$valid_participant])` were tested in Barcelona.
* From the longitudinal participants, `r length(participants$participant[(as.data.frame(table(participants$participant))$Freq>2) & participants$valid_participant])` were tested at two age groups, and `r length(participants$participant[(as.data.frame(table(participants$participant))$Freq>2) & participants$valid_participant])`were tested at three age groups.


### Summary

```{r participants_summary, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE, fig.height=4, out.width="100%"}
participants %>% 
	left_join(distinct(attrition, participant, valid_participant)) %>% 
	filter(valid_participant) %>% 
	drop_na(valid_participant) %>% 
	ggplot(aes(lp, fill = as.factor(test_language))) +
	facet_grid(location~age_group, scales = "free") +
	geom_bar(colour = NA) +
	geom_hline(yintercept = 24, linetype = "dashed") +
	scale_colour_brewer(palette = "Set1") +
	labs(x = "Group", y = "Sample size", fill = "Test language") +
	theme(
		legend.position = "top",
		axis.title.x = element_blank(),
		axis.text.x = element_text(size = 10),
		axis.title.y = element_text(angle = 90)
	) +
	ggsave(here("Figures", "sample.png"))

```

### Longitudinal

We collected data from `r sum(duplicated(participants$participant))` longitudinal participants, that is, who were tested in at least two of the three ages (21, 25, and 30). Of those, `r sum(duplicated(participants$participant[participants$location=="Oxford"]))` were tested in Oxford, and `r sum(duplicated(participants$participant[participants$location=="Barcelona"]))` were tested in Barcelona.

```{r participants_cohort, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE, fig.height=6, out.width="100%"}
# plot participants
participants %>% 
	left_join(distinct(attrition, participant, valid_participant)) %>% 
	mutate(
		valid_status = case_when(
			valid_participant & !is.na(vocab_size) ~ "Valid (+ CDI)",
			valid_participant & is.na(vocab_size) ~ "Valid (no CDI)",
			!valid_participant ~ "Not valid"
		),
		age_group = str_remove(age_group, " months")
	) %>%
	drop_na(valid_status) %>% 
	ggplot(aes(age_group, participant, colour = valid_status)) +
	facet_grid(location~lp, scales = "free") +
	geom_line(aes(group = interaction(lp, participant))) +
	geom_point(size = 2) +
	geom_hline(yintercept = 0.2, linetype = "dashed") +
	labs(x = "Age (months)", y = "Exposure to 2nd language", fill = "Validity status") +
	theme(
		legend.position = "right",
		legend.title = element_blank(),
		axis.text.x = element_text(size = 10),
		axis.title.y = element_blank(),
		axis.text.y = element_blank(),
		axis.ticks.y = element_blank()
	) +
	ggsave(here("Figures", "cohort.png"))
```


### Attrition (overall)

```{r participants_cdi, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE, fig.height=4, out.width="100%"}
# plot participants
participants %>% 
	left_join(distinct(attrition, participant, valid_participant)) %>% 
	drop_na(valid_participant) %>% 
	mutate(
		valid_status = case_when(
			valid_participant & !is.na(vocab_size) ~ "Valid (+ CDI)",
			valid_participant & is.na(vocab_size) ~ "Valid (no CDI)",
			!valid_participant ~ "Not valid"
		)
	) %>% 
	ggplot(aes(lp, fill = valid_status)) +
	facet_grid(location~age_group, scales = "free") +
	geom_bar(colour = NA) +
	geom_hline(yintercept = 24, linetype = "dashed") +
	scale_colour_brewer(palette = "Set1") +
	labs(x = "Group", y = "Sample size", fill = "Valid?") +
	theme(
		legend.position = "top",
		legend.title = element_blank(),
		axis.title.x = element_blank(),
		axis.text.x = element_text(size = 10),
		axis.title.y = element_text(angle = 90)
	) +
	ggsave(here("Figures", "participants_attrition.png"))
```

### Attrition (by group)

This table shows a summary of the total, total valid, and proportion of valid monolingual and bilingual participants tested in each lab (Barcelona and Oxford), in each age group (21, 25, and 30 months), and the mean of valid trials they contributed in each trial type (cognate, non-cognate, and unrelated). 

```{r attrition, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE, fig.height=12}

left_join(attrition, select(participants, age_group, location, lp, participant, date_test)) %>% 
	group_by(participant, lp, location, trial_type, date_test, age_group, valid_participant, valid_other) %>% 
	summarise(valid_trial_count = sum(valid_trial, na.rm = TRUE),
			  .groups = "drop") %>% 
	pivot_wider(
		names_from = trial_type,
		values_from = valid_trial_count
	) %>% 
	clean_names() %>% 
	group_by(lp, location, age_group) %>% 
	summarise(
		cognate = mean(cognate, na.rm = TRUE),
		non_cognate = mean(non_cognate, na.rm = TRUE),
		unrelated = mean(unrelated, na.rm = TRUE),
		sum_n = sum(valid_participant, na.rm = TRUE),
		prop_n = mean(valid_participant, na.rm = TRUE),
		n = n(),
		.groups = "drop"
	) %>% 
	arrange(age_group, lp, location) %>% 
	relocate(age_group, lp, location, cognate, non_cognate, unrelated, sum_n, n, prop_n) %>% 
	gt() %>% 
	tab_spanner(
		"Mean valid trials",
		c("cognate", "non_cognate", "unrelated")
	) %>% 
	tab_spanner(
		"N participants",
		c("sum_n", "n", "prop_n")
	) %>% 
	cols_label(
		age_group = "Age",
		lp = "Group",
		sum_n = "Valid",
		location = "Laboratory",
		n = "Tested",
		prop_n = "Valid (%)",
		cognate = "Cognate (8)",
		non_cognate = "Non-cognate (8)",
		unrelated = "Unrelated (16)"
	) %>% 
	fmt_number(c("cognate", "non_cognate", "unrelated")) %>%
	fmt_percent(c("prop_n")) %>% 
	fmt_number(c("n", "sum_n"), decimals = 0)

```


### Attrition (by participant)

```{r participants_attrition, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE, fig.height=4, out.width="100%"}
# plot participants
attrition %>% 
	left_join(select(participants, participant, location)) %>% 
	mutate(participant = str_remove(participant, "cognatepriming")) %>% 
	group_by(location, participant, lp, age_group, valid_participant) %>% 
	summarise(
		valid = mean(valid_trial),
		invalid_gaze = mean(!valid_gaze),
		invalid_other = mean(!valid_other),
		invalid_vocab = mean(!valid_vocab),
		.groups = "drop"
	) %>% 
	relocate(participant) %>% 
	relocate(invalid_other, .after = invalid_vocab) %>% 
	gt() %>% 
	tab_spanner(label = "Invalid trials", columns = starts_with("invalid_")) %>% 
	cols_label(
		participant = "Participant",
		location = "Location",
		lp = "Lang. Profile",
		age_group = "Age",
		valid_participant = "Valid participant",
		valid = "Valid trials (%)",
		invalid_gaze = "Gaze (%)",
		invalid_vocab = "Vocabulary (%)",
		invalid_other = "Other (%)"
	) %>% 
	fmt_percent(c("valid", "invalid_gaze", "invalid_vocab", "invalid_other")) %>% 
	div(style='height:600px; overflow-y: scroll', .)
```

### Attrition (by trials)

```{r trials_attrition_table, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE, fig.height=4, out.width="100%"}
# plot participants
attrition %>% 
	left_join(select(participants, participant, location)) %>% 
	group_by(location, lp, age_group, trial_type, valid_trial) %>% 
	count() %>% 
	ungroup() %>%
	mutate(valid_trial = ifelse(valid_trial, "Valid", "Not valid")) %>% 
	pivot_wider(names_from = c(age_group, valid_trial), values_from = n, values_fill = 0) %>% 
	clean_names() %>% 
	gt(groupname_col = c("location", "lp")) %>% 
	tab_spanner(label = "21 months", columns = contains("21_")) %>% 
	tab_spanner(label = "25 months", columns = contains("25_")) %>% 
	tab_spanner(label = "30 months", columns = contains("30_")) %>% 
	cols_label(
		location = "Location",
		lp = "Group",
		trial_type = "Trial type",
		x21_months_not_valid = "Not valid",
		x21_months_valid = "Valid",
		x25_months_not_valid = "Not valid",
		x25_months_valid = "Valid",
		x30_months_not_valid = "Not valid",
		x30_months_valid = "Valid"
	)


```


```{r trials_attrition, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE, fig.height=4, out.width="100%"}
# plot participants
attrition %>% 
	left_join(select(participants, participant, location)) %>% 
	mutate(valid_status = case_when(
		!valid_vocab ~ "Invalid vocabulary",
		!valid_gaze ~ "Invalid gaze",
		!valid_other ~ "Other",
		!valid_participant ~ "Invalid participant",
		TRUE ~ "Valid"
	)) %>% 
	count(location, lp, age_group, trial_type, valid_status) %>% 
	ggplot(aes(trial_type, n, fill = valid_status, colour = valid_status)) +
	facet_grid(lp~age_group) +
	geom_col(position = position_fill()) +
	labs(x = "Trial type", y = "Trials", colour = "Validity", fill = "Validity") +
	scale_y_continuous(labels = scales::percent) +
	guides(fill = guide_legend(ncol = 2), colour = guide_legend(ncol = 2))	+
	theme(
		legend.position = "top",
		legend.title = element_blank(),
		axis.text.x = element_text(angle = 20, hjust = 1),
		axis.text.y = element_text(size = 8),
		axis.title.y = element_blank()
	)
```


### {-}

## Materials

## Procedure

## Data analysis

### Vocabulary data

We collected vocabulary data from participants. In Oxford, participants were sent the online version of the Oxford Communicative Development Inventory [OCDI; @hamilton2000] two weeks before each appointment. In Barcelona, participants were sent the online vocabulary inventory [MultiLex](https://github.com/gongcastro/multilex) immediately after the appointment, and were given two weeks to fill it. In Oxford, families filled the vocabulary checklist in the testing language, and when the participant was monolingual, also in the second language. In Barcelona, all participants filled the Catalan and the Spanish versions of the vocabulary checklists. All checklists included the words involved in the trial lists. When filling the vocabulary checklist, families checked each word as being *understood*, *understood and produced* or *none*. Each response to either checklist was aggregated to produce several vocabulary measures:

* **Total vocabulary**: total number of words the child knows, summing up both languages. For instance, a child who knows 210 words in Catalan and 100 words in Spanish would have a total vocabulary size of 210 words.
* **L1 vocabulary**: number of words the child knows in the languages of higher exposure (i.e., testing language). For instance, for a child exposed to 75% Catalan who knows 210 words in Catalan and 100 words in Spanish, their L1 vocabulary size would be 210 words.
* **Conceptual vocabulary**: number of lexicalised concepts, that is, the number of concepts for which the child knows a word in at least one of the languages. For example, a Catalan-Spanish bilingual that knows *taula* and *mesa* -- Catalan and Spanish translations of *table*-- would have a conceptual vocabulary size of 1.

Vocabulary sizes of participants whose families failed to complete the vocabulary checklists were imputed, by assigning them the most likely vocabulary size from a distribution of vocabulary sizes of children of similar age ($\pm$ 1 month) and language profile (similar exposure to a second language, $\pm$ 10%) that completed the same vocabulary checklist previously.


## Gaze data {.tabset .tabset-pills}

Each trial was divided into 100 ms time bins. for each time bin, the proportion of  target fixations were calculated, from the total of fixations to the target, distractor and the rest of the screen for that same time bin. Proportions were then aggregated across trials for each time bin and participants, so that each participant contributed with 20 data points (one for each time bin) for each trial type (cognate, non-cognate, and unrelated).

### Workflow

```{r workflow_preprocessing, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
DiagrammeR::grViz("digraph {
  graph [layout = dot, rankdir = TB]
  
  node [shape = rectangle, fontname = 'Arial']        
  rec1 [label = 'Merge Barcelona and Oxford data']
  rec2 [label = 'Impute missing/invalid samples (pending)']
  rec2 [label = 'Extract fixations (pending)']
  rec3 [label = 'For each sample, evaluate if gaze is in target or distractor']
  rec4 [label = 'Divide each trial into 100 ms time bins']
  rec5 [label = 'Aggregate samples from the same time bin and calculate\nthe number of valid samples in target, distractor, or none']
  rec6 [label = 'Exclude time bins 1-3 (pending)']
  rec7 [label = 'Apply trial-level inclusion criteria']
  rec8 [label = 'Apply participant-level inclusion criteria']

  
  # edge definitions with the node IDs
  rec1 -> rec2 -> rec3 -> rec4 -> rec5 -> rec6 -> rec7 -> rec8
  }", 
  height = 500)
```

### Trial-level inclusion criteria

* $\geq$ 50% or more valid samples during prime phase (1,500 ms)
* $\geq$ 50% or more valid samples during target-distractor phase (2,000 ms)
* At least one sample in target and one sample in distractor
* Participant understands prime word in both languages
* Participant knows the target word in the test language
* Participant knows the distractor word in the test language

### Participant-level inclusion criteria

* $\geq$ 4 trials in *Cognate* condition (50%, from a total of 8)
* $\geq$ 4 trials in *Non-cognate* condition (50%, from a total of 8)
* $\geq$ 8 trials in *Unrelated* condition (50%, from a total of 16)
* $\geq$ 36 gestational weeks
* $\geq$ 2,800g birth weight
* No diagnosed developmental, hearing, or visual disorders
* Not exposed to more than 10% to a 3rd language


### {-}

# Results

## Vocabulary

This figure represents the vocabulary size in the dominant language of participants in the Y-axis and their linguistic profile in the X-axis. Results are presented separately for each age group. The shape of the violins, represents the distribution of the vocabulary sizes. The box-plot inside each violin represents the median, 25th and 75th percentiles, and the vertical lines represent the minimum and maximum values. vocabulary sizes in the dominant language were calculated as the proportion of items each participant was reported to *understand* or *understand and say* in the language of most exposure. for example, for a participant exposed mostly to Catalan, their vocabulary size in the dominant language was calculated as the proportion of words they were reported to understand and/or say in Catalan, from a total of ~200 words.

```{r vocabulary, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE, fig.height=4}
sample_size <- participants %>% 
	count(age_group, location)

# vocabulary
participants %>% 
	left_join(distinct(attrition, participant, age_group, valid_participant)) %>% 
	drop_na(lp) %>%
	filter(valid_participant) %>% 
	ggplot(aes(lp, vocab_size, colour = lp, fill = lp)) +
	facet_wrap(location~age_group) +
	geom_violin(position = position_dodge(width = 0.75)) + 
	# geom_point(shape = 1, colour = "black", alpha = 0.5, size = 3, stroke = 1,
	# 		   position = position_jitter(width = 0.1, seed = 888)) +
	geom_boxplot(width = 0.1, colour = "black", fill = "white", outlier.colour = NA,
				 position = position_dodge(width = 0.75)) +
		geom_text(data = sample_size,
			  aes(x = 1.5, y = 0.95, label = paste0("n = ", n),
			  	colour = "black", fill = "black"), show.legend = FALSE) +
	labs(y = "Receptive vocabulary size (L1)", colour = "Group", fill = "Group") +
	scale_y_continuous(limits = c(0, 1), labels = scales::percent) +
	theme(legend.title = element_blank(),
		  legend.position = "none",
		  axis.title.x = element_blank(),
		  panel.grid.major.y = element_line(colour = "grey", linetype = "dotted")) +
	ggsave(here("Figures", "vocabulary.png"))

```


## Target fixations {.tabset .tab-pills}


### Aggregated by trial

For each participant and trial, the proportion of fixations to the target object were calculated from the total of fixations to the target, the distractor, and the rest of the screen. Then proportions for the same participant were aggregated within conditions, so that for each participant three data points were obtained: one in each trial type (cognate, non-cognate, and unrelated). Some participants were longitudinal. Scores form longitudinal participant  are indicated by grey lines linking data points from the same participant.


```{r gaze_trial_age, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
sample_size <- participants %>% 
	count(age_group, lp)

gaze %>% 
	left_join(select(attrition, participant, age_group, valid_trial, valid_participant)) %>% 
	left_join(select(participants, participant, age_group, location)) %>% 
	filter(valid_participant, valid_trial) %>% 
	group_by(participant, lp, trial_type, age_group, location) %>% 
	summarise(
		prop = mean(prop, na.rm = TRUE),
		.groups = "drop"
	) %>% 
	drop_na() %>% 
	ggplot(aes(trial_type, prop, colour = trial_type, fill = trial_type)) +
	facet_grid(lp~age_group) +
	geom_hline(yintercept = 0.5, linetype = "dashed") +
	geom_violin(position = position_dodge(width = 0.75)) +
	#stat_slab(position = position_nudge(x = 0.25)) +
	#geom_point(size = 2, shape = 1, stroke = 1, position = position_jitter(width = 0.1)) +
	geom_boxplot(aes(group = interaction(age_group, trial_type)), width = 0.1, outlier.colour = NA,
				 position = position_dodge(width = 0.75), colour = "black", fill = "white") +
	geom_text(data = sample_size,
			  aes(x = 1, y = 0.95, label = paste0("n = ", n),
			  	colour = "black", fill = "black"), show.legend = FALSE) +
	labs(x = "Trial type", y = "Target looking / Total looking", colour = "Condition", fill = "Condition") + 
	scale_y_continuous(limits = c(0, 1), labels = scales::percent) +
	theme(legend.position = "none",
		  axis.title.x = element_blank(),
		  axis.text.x = element_text(angle = 30, vjust = 1, hjust = 1),
		  panel.grid.major.y = element_line(colour = "grey", linetype = "dotted")) +
	ggsave(here("Figures", "gaze_trial_age.png"))

```


### Growth curve analysis {.tabset .tab-pills}


#### Model details

We fit a multilevel regression model using the `lmer` function of the `lme4` package, used the following formula:

```
elog ~ age_group + trial_type * lp * (ot1 + ot2 + ot3) +
(1 + ot1 + ot2 + ot3 + trial_type + age_group | participant)
```

The formal implementation of this model is:

$$
\log(\frac{p}{n - q}) = (\beta_{0} + \beta_{0p} + \beta_{0i}) + ... \\
(\beta_{1} + \beta_{1p} + \beta_{1i})\times Condition_{pi} + ... \\
(\beta_{2} + \beta_{2i}) \times Group_{pi} + ... \\
(\beta_{3} + \beta_{3i}) \times (Condition_{pi} \times Group_{pi}) + ... \\
(\beta_{4} + \beta_{4p}) \times Vocabulary_{p} + \varepsilon_{pi}
$$


#### Fixed effects

```{r fixed_effects_table, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
confint.merMod(fit, method = "Wald") %>% 
	as.data.frame() %>% 
	clean_names() %>% 
	drop_na(x2_5_percent) %>%
	rownames_to_column("term") %>% 
	right_join(clean_names(tidy(fit, effects = "fixed"))) %>% 
	select(term, estimate, std_error, conf_lower = x2_5_percent, conf_upper = x97_5_percent,
		   statistic, df, p_value) %>% 
	gt() %>% 
	fmt_number(2:7) %>% 
	fmt_number(8, decimals = 3) %>% 
	cols_merge(starts_with("conf_"), pattern = "[{1}, {2}]") %>% 
	cols_label(
		term = md("**Predictor**"),
		estimate = md("**Estimate**"),
		std_error = md("**SE**"),
		conf_lower = md("**CI<sub>95%</sub>**"),
		statistic = md("***t***"),
		df = md("**df**"),
		p_value = md("***p***")
	) %>% 
	tab_style(
		style = list(
			cell_fill(color = "#F9E3D6")
		),
		locations = cells_body(
			columns = everything(),
			rows = p_value < 0.05
		)
	)
```


#### Random effects

```{r random_effects_participant, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}

VarCorr(fit)$participant %>% 
	as.data.frame() %>% 
	rownames_to_column("term1") %>% 
	pivot_longer(-term1, names_to = "term2", values_to = "value") %>% 
	ggplot(aes(term1, term2, fill = value)) +
	geom_tile() +
	coord_fixed() +
	labs(x = "Term 1", y = "Term 2", fill = "Covariance") +
	scale_fill_viridis_c() +
	theme(
		axis.title = element_blank(),
		axis.text.x = element_text(angle = 90)
	)

```


##### {-}

#### {-}

#### Marginal means {.tabset .tab-pills}

##### Overall

```{r gaze_time, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
y_pred <- logit_to_prob(predict(fit))
sample_size <- participants %>% 
	filter(valid_participant) %>%
	count(age_group, lp)

gaze %>% 
	drop_na() %>% 
	ggplot(aes(x = ot1, y = prop, colour = trial_type, fill = trial_type)) +
	facet_grid(lp~age_group) +
	geom_hline(yintercept = 0.5, size = 1, colour = "grey") +
	stat_summary(fun.data = mean_se, aes(y = y_pred), geom = "ribbon", alpha = 0.5, colour = NA) +
	stat_summary(fun = mean, aes(y = y_pred), geom = "line", size = 1) +
	stat_summary(fun.data = mean_se, geom = "pointrange", size = 0.25) +
	geom_text(data = sample_size,
			  aes(x = -0.3, y = 0.95, label = paste0("n = ", n),
			  	colour = "black", fill = "black"), show.legend = FALSE) +
	labs(x = "Time bin (100 ms)", y = "Prob. of target fixation",
		 colour = "Trial type", fill = "Trial type") +
	scale_y_continuous(limits = c(0, 1), labels = scales::percent) + 
	scale_x_continuous(breaks = unique(gaze$ot1), labels = unique(gaze$time_bin)) +
	theme_custom() +
	theme(
		legend.position = "top",
		axis.text = element_text(size = 7)
	)
```

##### By vocabulary size


```{r gaze_time_vocab_lower, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
sample_size <- participants %>% 
	filter(vocab_size <= median(.$vocab_size, na.rm = TRUE), valid_participant) %>% 
	count(age_group, lp)

augment(fit) %>% 
	mutate(.fitted_prob = logit_to_prob(.fitted)) %>% 
	filter(vocab_size <= median(.$vocab_size)) %>% 
	ggplot(aes(x = ot1, y = .fitted_prob, colour = trial_type, fill = trial_type)) +
	facet_grid(lp~age_group) +
	geom_hline(yintercept = 0.5, size = 1, colour = "grey") +
	stat_summary(fun.data = mean_se, aes(y = .fitted_prob), geom = "ribbon", alpha = 0.5, colour = NA) +
	stat_summary(fun = mean, aes(y = .fitted_prob), geom = "line", size = 1) +
	geom_text(data = sample_size,
			  aes(x = -0.3, y = 0.95, label = paste0("n = ", n),
			  	colour = "black", fill = "black"), show.legend = FALSE) +
	# stat_summary(fun.data = mean_se, geom = "pointrange", size = 0.25) +
	labs(x = "Time bin (100 ms)", y = "Prob. of target fixation",
		 colour = "Trial type", fill = "Trial type",
		 title = "Vocabulary size <= median") +
	scale_y_continuous(limits = c(0, 1)) + 
	scale_x_continuous(breaks = unique(gaze$ot1), labels = unique(gaze$time_bin)) +
	theme(
		legend.position = "top",
		axis.text = element_text(size = 7)
	)
```


```{r gaze_time_vocab_upper, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
sample_size <- participants %>% 
	filter(vocab_size > median(.$vocab_size, na.rm = TRUE), valid_participant) %>% 
	count(age_group, lp)

augment(fit) %>% 
	mutate(.fitted_prob = logit_to_prob(.fitted)) %>% 
	filter(vocab_size > median(.$vocab_size)) %>% 
	ggplot(aes(x = ot1, y = .fitted_prob, colour = trial_type, fill = trial_type)) +
	facet_grid(lp~age_group) +
	geom_hline(yintercept = 0.5, size = 1, colour = "grey") +
	stat_summary(fun.data = mean_se, aes(y = .fitted_prob), geom = "ribbon", alpha = 0.5, colour = NA) +
	stat_summary(fun = mean, aes(y = .fitted_prob), geom = "line", size = 1) +
	geom_text(data = sample_size,
			  aes(x = -0.3, y = 0.95, label = paste0("n = ", n),
			  	colour = "black", fill = "black"), show.legend = FALSE) +
	# stat_summary(fun.data = mean_se, geom = "pointrange", size = 0.25) +
	labs(x = "Time bin (100 ms)", y = "Prob. of target fixation",
		 colour = "Trial type", fill = "Trial type",
		 title = "Vocabulary size > median") +
	scale_y_continuous(limits = c(0, 1)) + 
	scale_x_continuous(breaks = unique(gaze$ot1), labels = unique(gaze$time_bin)) +
	theme(
		legend.position = "top",
		axis.text = element_text(size = 7)
	)
```

##### By location


```{r gaze_time_location_barcelona, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
sample_size <- participants %>% 
	filter(location=="Barcelona", valid_participant) %>% 
	count(age_group, lp)

augment(fit) %>% 
	left_join(distinct(participants, participant, location)) %>% 
	mutate(.fitted_prob = logit_to_prob(.fitted)) %>% 
	filter(location=="Barcelona") %>% 
	ggplot(aes(x = ot1, y = .fitted_prob, colour = trial_type, fill = trial_type)) +
	facet_grid(lp~age_group) +
	geom_hline(yintercept = 0.5, size = 1, colour = "grey") +
	stat_summary(fun.data = mean_se, aes(y = .fitted_prob), geom = "ribbon", alpha = 0.5, colour = NA) +
	stat_summary(fun = mean, aes(y = .fitted_prob), geom = "line", size = 1) +
	geom_text(data = sample_size,
			  aes(x = -0.3, y = 0.95, label = paste0("n = ", n),
			  	colour = "black", fill = "black"), show.legend = FALSE) +
	# stat_summary(fun.data = mean_se, geom = "pointrange", size = 0.25) +
	labs(x = "Time bin (100 ms)", y = "Prob. of target fixation",
		 colour = "Trial type", fill = "Trial type",
		 title = "Barcelona") +
	scale_y_continuous(limits = c(0, 1)) + 
	scale_x_continuous(breaks = unique(gaze$ot1), labels = unique(gaze$time_bin)) +
	theme(
		legend.position = "top",
		axis.text = element_text(size = 7)
	)
```


```{r gaze_time_location_oxford, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
sample_size <- participants %>% 
	filter(location=="Oxford") %>% 
	count(age_group, lp)

augment(fit) %>% 
	left_join(distinct(participants, participant, location)) %>% 
	mutate(.fitted_prob = logit_to_prob(.fitted)) %>% 
	filter(location=="Oxford") %>% 
	ggplot(aes(x = ot1, y = .fitted_prob, colour = trial_type, fill = trial_type)) +
	facet_grid(lp~age_group) +
	geom_hline(yintercept = 0.5, size = 1, colour = "grey") +
	stat_summary(fun.data = mean_se, aes(y = .fitted_prob), geom = "ribbon", alpha = 0.5, colour = NA) +
	stat_summary(fun = mean, aes(y = .fitted_prob), geom = "line", size = 1) +
	geom_text(data = sample_size,
			  aes(x = -0.3, y = 0.95, label = paste0("n = ", n),
			  	colour = "black", fill = "black"), show.legend = FALSE) +
	# stat_summary(fun.data = mean_se, geom = "pointrange", size = 0.25) +
	labs(x = "Time bin (100 ms)", y = "Prob. of target fixation",
		 colour = "Trial type", fill = "Trial type",
		 title = "Oxford") +
	scale_y_continuous(limits = c(0, 1)) + 
	scale_x_continuous(breaks = unique(gaze$ot1), labels = unique(gaze$time_bin)) +
	theme(
		legend.position = "top",
		axis.text = element_text(size = 7)
	)
```

##### {-}

#### {-}



# Appendix {.tabset .tab-pills}

## Appendix 1: Individual attrition rates

```{r attrition_individual, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE, fig.height=12}

attrition %>%
	left_join(select(participants, location, lp, participant, date_test)) %>% 
	drop_na(trial_type) %>% 
	group_by(participant, lp, location, date_test, age_group, trial_type, valid_participant, valid_other) %>% 
	summarise(valid_trial_count = sum(valid_trial, na.rm = TRUE),
			  .groups = "drop") %>% 
	pivot_wider(names_from = trial_type, values_from = valid_trial_count) %>% 
	clean_names() %>% 
	mutate(
		participant = str_remove(participant, "cognatepriming"),
		cognate = paste0(cognate, " (", round(cognate/8, 2), "%)"),
		non_cognate = paste0(non_cognate, " (", round(non_cognate/8, 2), "%)"),
		unrelated = paste0(unrelated, " (", round(unrelated/8, 2), "%)"),
	) %>% 
	arrange(location, date_test) %>% 
	relocate(
		participant, location, date_test,
		age_group, lp, cognate, non_cognate,
		unrelated, valid_other, valid_participant) %>% 
	gt() %>% 
	tab_spanner(
		"Valid trials (%) by trial type",
		c("cognate", "non_cognate", "unrelated")
	) %>% 
	cols_label(
		participant = "Participant",
		location = "Location",
		date_test = "Date",
		lp = "Group",
		age_group = "Age",
		valid_participant = "Valid trials",
		valid_other = "Valid (other)?",
		cognate = "Cognate",
		non_cognate = "Non-cognate",
		unrelated = "Unrelated"
	) %>% 
	tab_style(
		style = list(
			cell_fill(color = "#00FA9A")
		),
		locations = cells_body(
			columns = c("valid_participant"),
			rows = valid_participant
		)
	) %>% 
	tab_style(
		style = list(
			cell_fill(color = "#00FA9A")
		),
		locations = cells_body(
			columns = c("valid_other"),
			rows = valid_other
		)
	)

```

## {-}

# References