---
title: "Report"
output:
  html_document:
    df_print: paged
    toc: true
    toc_depth: 2
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = FALSE,
	message = TRUE,
	warning = TRUE, 
	cache.extra = knitr::rand_seed,
	out.width = "100%",
	results = "asis",
	dev.args = list(png = list(type = "cairo"))
)
options(knitr.kable.NA = '-')

```

```{r prepare, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}

# load packages
library(papaja)
library(knitr)
library(tidyverse)
library(bilingualr)
library(lubridate)
library(scales)
library(janitor)
library(gt)
library(patchwork)
library(here)

# load data
participants <- readRDS(here("Results", "participants.rds"))
gaze_trial <- readRDS(here("Results", "gaze_trial.rds"))
gaze_time <- readRDS(here("Results", "gaze_time.rds"))
attrition <- readRDS(here("Results", "attrition.rds"))

```


# Participants

## Sample sizes

```{r participants, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE, fig.height=4, out.width="100%"}
# plot participants
participants %>% 
	drop_na(valid_participant) %>% 
	mutate(valid_participant = ifelse(valid_participant, "Valid", "Not valid")) %>% 
	ggplot(aes(lp, fill = valid_participant)) +
	facet_grid(location~age_group, scales = "free") +
	geom_bar() +
	geom_hline(yintercept = 24, linetype = "dashed") +
	labs(x = "Group", y = "Sample size", fill = "Valid?") +
	scale_fill_brewer(palette = "Set1") +
	theme_bilingual() +
	theme(
		legend.position = "top",
		legend.title = element_blank(),
		axis.title.x = element_blank(),
		axis.text.x = element_text(size = 10),
		axis.title.y = element_text(angle = 90)
	) +
	ggsave(here("Figures", "sample.png"))
```

## Language profiles

Only valid participants.

```{r lps, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE, fig.height=4, out.width="100%"}
# plot participants
participants %>% 
	filter(valid_participant) %>% 
	ggplot(aes(age, doe_2, colour = lp)) +
	facet_grid(test_language~location) +
	geom_line(aes(group = interaction(lp, participant)), alpha = 0.5) +
	geom_point(size = 3, alpha = 0.5) +
	geom_hline(yintercept = 0.2, linetype = "dashed") +
	annotate(geom = "rect", alpha = 0.25, fill = "grey", colour = NA,
			 xmin = 20, xmax = 22, ymin = -Inf, ymax = Inf) +
	annotate(geom = "rect", alpha = 0.25, fill = "grey", colour = NA,
			 xmin = 24, xmax = 26, ymin = -Inf, ymax = Inf) +
	annotate(geom = "rect", alpha = 0.25, fill = "grey", colour = NA,
			 xmin = 28, xmax = 32, ymin = -Inf, ymax = Inf) +
	labs(x = "Age (months)", y = "Exposure to 2nd language", fill = "Group") +
	scale_colour_brewer(palette = "Set1") +
	scale_y_continuous(labels = percent) +
	theme_bilingual() +
	theme(
		legend.position = "top",
		legend.title = element_blank(),
		panel.grid.major.y = element_line(linetype = "dotted", colour = "grey"),
		axis.text.x = element_text(size = 10),
		axis.title.y = element_text(angle = 90),
		axis.text.y = element_text(size = 10)
	) +
	ggsave(here("Figures", "lps.png"))
```


# Results

## Attrition rate

This table shows a summary of the total, total valid, and proportion of valid monolingual and bilingual participants tested in each lab (Barcelona and Oxford), in each age group (21, 25, and 30 months), and the mean of valid trials they contributed in each trial type (cognate, non-cognate, and unrelated). 

```{r attrition, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE, fig.height=12}

attrition %>%
	left_join(select(participants, location, lp, participant, date_test)) %>% 
	drop_na(trial_type) %>% 
	group_by(participant, lp, location, date_test, age_group, trial_type, valid_participant, valid_other) %>% 
	summarise(valid_trial_count = sum(valid_trial, na.rm = TRUE),
			  .groups = "drop") %>% 
	pivot_wider(
		names_from = trial_type,
		values_from = valid_trial_count
	) %>% 
	clean_names() %>% 
	group_by(lp, location, age_group) %>% 
	summarise(
		cognate = mean(cognate, na.rm = TRUE),
		non_cognate = mean(non_cognate, na.rm = TRUE),
		unrelated = mean(unrelated, na.rm = TRUE),
		sum_n = sum(valid_participant, na.rm = TRUE),
		prop_n = mean(valid_participant, na.rm = TRUE),
		n = n(),
		.groups = "drop"
	) %>% 
	arrange(age_group, lp, location) %>% 
	relocate(age_group, lp, location, cognate, non_cognate, unrelated, sum_n, n, prop_n) %>% 
	gt() %>% 
	tab_spanner(
		"Mean valid trials",
		c("cognate", "non_cognate", "unrelated")
	) %>% 
	tab_spanner(
		"N participants",
		c("sum_n", "n", "prop_n")
	) %>% 
	cols_label(
		age_group = "Age",
		lp = "Group",
		sum_n = "Valid",
		location = "Laboratory",
		n = "Tested",
		prop_n = "Valid (%)",
		cognate = "Cognate (8)",
		non_cognate = "Non-cognate (8)",
		unrelated = "Unrelated (16)"
	) %>% 
	fmt_number(c("cognate", "non_cognate", "unrelated")) %>%
	fmt_percent(c("prop_n")) %>% 
	fmt_number(c("n", "sum_n"), decimals = 0)

```

## Vocabulary

### Vocabulary in the dominant language (L1)

This figure represents the vocabulary size in the dominant language of participants in the Y-axis and their linguistic profile in the X-axis. Results are presented separately for each age group. The shape of the violins, represents the distribution of the vocabulary sizes. The box-plot inside each violin represents the median, 25th and 75th percentiles, and the vertical lines represent the minimum and maximum values. vocabulary sizes in the dominant language were calculated as the proportion of items each participant was reported to *understand* or *understand and say* in the language of most exposure. for example, for a participant exposed mostly to Catalan, their vocabulary size in the dominant language was calculated as the proportion of words they were reported to understand and/or say in Catalan, from a total of ~200 words.

```{r vocabulary, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE, fig.height=4}
# vocabulary
participants %>% 
	mutate(age_group = as.factor(paste0(age_group, " mo"))) %>% 
	drop_na(lp) %>% 
	ggplot(aes(lp, vocab_size, colour = lp, fill = lp)) +
	facet_wrap(~age_group) +
	geom_violin(position = position_dodge(width = 0.75)) + 
	# geom_point(shape = 1, colour = "black", alpha = 0.5, size = 3, stroke = 1,
	# 		   position = position_jitter(width = 0.1, seed = 888)) +
	geom_boxplot(width = 0.1, colour = "black", fill = "white", outlier.colour = NA,
				 position = position_dodge(width = 0.75)) +
	labs(y = "Receptive vocabulary size (L1)", colour = "Group", fill = "Group") +
	scale_colour_brewer(palette = "Set1") +
	scale_fill_brewer(palette = "Set1") +
	theme_bilingual() +
	theme(legend.title = element_blank(),
		  legend.position = "none",
		  axis.title.x = element_blank(),
		  panel.grid.major.y = element_line(colour = "grey", linetype = "dotted")) +
	ggsave(here("Figures", "vocabulary.png"))

```


## Target fixations

### Target fixations: Age group and language profile {.tabset .tabset-pills}

#### Cross-sectional

For each participant and trial, the proportion of fixations to the target object were calculated from the total of fixations to the target, the distractor, and the rest of the screen. Then proportions for the same participant were aggregated within conditions, so that for each participant three data points were obtained: one in each trial type (cognate, non-cognate, and unrelated). Some participants were longitudinal. Scores form longitudinal participant  are indicated by gray lines linking data points from the same participant.

```{r gaze_trial, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
gaze_trial %>% 
	left_join(select(attrition, participant, age_group, valid_trial, valid_participant)) %>% 
	filter(valid_participant, valid_trial) %>% 
	group_by(participant, lp, trial_type, age_group, location) %>% 
	summarise(prop = mean(prop), .groups = "drop") %>% 
	drop_na() %>% 
	ggplot(aes(trial_type, prop, colour = trial_type, fill = trial_type)) +
	facet_grid(lp~age_group) +
	geom_violin() +
	geom_hline(yintercept = 0.5, linetype = "dashed") +
	geom_line(aes(group = participant), colour = "grey", alpha = 0.5) +
	#stat_slab(position = position_nudge(x = 0.25)) +
	geom_boxplot(width = 0.1, colour = "black", fill = "white", outlier.colour = NA) +
	#geom_point(size = 2, shape = 1, stroke = 1) +
	labs(x = "Condition", y = "Target looking / Total looking", colour = "Condition", fill = "Condition") + 
	scale_colour_brewer(palette = "Set1") +
	scale_fill_brewer(palette = "Set1") +
	scale_y_continuous(limits = c(0, 1), labels = scales::percent) +
	theme_bilingual() +
	theme(legend.position = "none",
		  axis.text.x = element_text(angle = 30, vjust = 1, hjust = 1),
		  panel.grid.major.y = element_line(colour = "grey", linetype = "dotted")) +
	ggsave(here("Figures", "gaze_trial.png"))

```


#### Longitudinal

Each trial was divided into 100 ms time bins. for each time bin, the proportion of  target fixations were calculated, from the total of fixations to the target, distractor and the rest of the screen for that same time bin. Proportions were then aggregated across trials for each time bin and participants, so that each participant contributed with 20 data points (one for each time bin) for each trial type (cognate, non-cognate, and unrelated). This figure shows the fitted line of a General Additive Model (GAM) generated using the `geom_smooth()` function from the `ggplot` R package, with default settings.


```{r gaze_trial_age, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
gaze_trial %>% 
	left_join(select(attrition, participant, age_group, valid_trial, valid_participant)) %>% 
	filter(valid_participant, valid_trial) %>% 
	group_by(participant, lp, trial_type, age_group, location) %>% 
	summarise(prop = mean(prop), .groups = "drop") %>% 
	drop_na() %>% 
	ggplot(aes(age_group, prop, colour = trial_type, fill = trial_type)) +
	facet_grid(~lp) +
	geom_hline(yintercept = 0.5, linetype = "dashed") +
	geom_line(aes(group = interaction(participant, trial_type)), alpha = 0.5) +
	geom_violin(position = position_dodge(width = 0.5)) +
	#stat_slab(position = position_nudge(x = 0.25)) +
	#geom_point(size = 2, shape = 1, stroke = 1, position = position_jitter(width = 0.1)) +
	geom_boxplot(aes(group = interaction(age_group, trial_type)), width = 0.1, outlier.colour = NA,
				 position = position_dodge(width = 0.5), colour = "black", fill = "white") +
	labs(x = "Age (months)", y = "Target looking / Total looking", colour = "Condition", fill = "Condition") + 
	scale_colour_brewer(palette = "Set1") +
	scale_fill_brewer(palette = "Set1") +
	scale_y_continuous(limits = c(0, 1), labels = scales::percent) +
	theme_bilingual() +
	theme(legend.position = "top",
		  panel.grid.major.y = element_line(colour = "grey", linetype = "dotted")) +
	ggsave(here("Figures", "gaze_trial_age.png"))

```

### {-}

### Target fixations: Time course analysis

```{r gaze_time, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
gaze_time %>% 
	left_join(select(attrition, participant, age_group, valid_trial, valid_participant)) %>% 
	filter(valid_participant, valid_trial) %>% 
	group_by(time_bin, trial_type, lp, age_group,location) %>% 
	summarise(
		prop = mean(prop, na.rm = TRUE),
		n = n(),
		.groups = "drop"
	) %>% 
	ungroup() %>% 
	mutate(
		se = sqrt((prop*(1-prop))/(n+4)),
		lower = prop-se,
		upper = prop+se
	) %>% 
	drop_na() %>% 
	ggplot(aes(x = time_bin, y = prop, colour = trial_type, fill = trial_type)) +
	facet_grid(lp~age_group) +
	geom_hline(yintercept = 0.5, linetype = "dashed") +
	geom_smooth() +
	#geom_line() +
	#geom_ribbon(aes(ymin = lower, ymax = upper), width = 0) 
	geom_point(alpha = 0.5) +
	labs(x = "Time bin (100 ms)", y = "Fixations", colour = "Condition", fill = "Condition") +
	scale_y_continuous(limits = c(0, 1), labels = scales::percent) +
	scale_colour_brewer(palette = "Set1") +
	scale_fill_brewer(palette = "Set1") +
	theme_bilingual() +
	theme(legend.title = element_blank(),
		  legend.position = "top",
		  panel.grid = element_line(colour = "grey", linetype = "dotted")) +
	ggsave(here("Figures", "gaze_time.png"))

```


### Target fixations: Vocabulary size

```{r gaze_trial_vocabulary, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
gaze_trial %>% 
	left_join(select(attrition, participant, age_group, valid_trial, valid_participant)) %>% 
	filter(valid_participant, valid_trial) %>% 
	group_by(participant, lp, trial_type, age_group, vocab_size) %>% 
	summarise(prop = mean(prop), .groups = "drop") %>% 
	drop_na() %>% 
	ggplot(aes(vocab_size, prop, colour = trial_type, fill = trial_type)) +
	facet_grid(lp~age_group) +
	geom_hline(yintercept = 0.5, linetype = "dashed") +
	geom_line(aes(group = participant), colour = "grey", alpha = 0.5) +
	#stat_slab(position = position_nudge(x = 0.25)) +
	geom_point(alpha = 0.5) +
	geom_smooth(se = FALSE, method = "lm") +
	labs(x = "L1 vocabulary size", y = "Target looking / Total looking", colour = "Condition", fill = "Condition") + 
	scale_colour_brewer(palette = "Set1") +
	scale_x_continuous(limits = c(0, 1), labels = scales::percent) +
	scale_y_continuous(limits = c(0, 1), labels = scales::percent) +
	theme_bilingual() +
	theme(panel.grid.major.y = element_line(colour = "grey", linetype = "dotted"),
		  legend.position = "top",
		  axis.text.x = element_text(size = 10)) +
	ggsave(here("Figures", "gaze_trial_vocabulary.png"))
```


### Target fixations: High vocabulary vs. low vocabulary {.tabset .tabset-pills}


```{r gaze_time_vocab, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE, fig.height=8}
gaze_time_vocab_d <- gaze_time %>% 
	left_join(select(attrition, participant, age_group, valid_trial, valid_participant)) %>% 
	left_join(select(participants, participant, age_group, vocab_size)) %>% 
	filter(valid_participant, valid_trial) %>% 
	group_by(time_bin, trial_type, lp, age_group,location, vocab_size) %>% 
	summarise(
		prop = mean(prop, na.rm = TRUE),
		n = n(),
		.groups = "drop"
	) %>% 
	ungroup() %>% 
	mutate(
		se = sqrt((prop*(1-prop))/(n+4)),
		lower = prop-se,
		upper = prop+se,
		vocab_cat = ifelse(
			vocab_size < median(.$vocab_size, na.rm = TRUE),
			"Below the median",
			"Above the median"
		),
		age_group = paste0(age_group, " months")
	) %>% 
	drop_na()

```


#### Age group: 21 months

```{r gaze_time_vocab_21, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}

gaze_time_vocab_d %>% 
	filter(age_group == "21 months") %>% 
	ggplot(aes(x = time_bin, y = prop, colour = trial_type, fill = trial_type)) +
	facet_grid(lp~vocab_cat) +
	geom_hline(yintercept = 0.5, linetype = "dashed") +
	geom_smooth() +
	stat_summary(fun.data = mean_se, geom = "pointrange", size = 0.25) +
	#geom_line() +
	#geom_ribbon(aes(ymin = lower, ymax = upper), width = 0) 
	#geom_point(alpha = 0.5) +
	labs(x = "Time bin (100 ms)", y = "Fixations", colour = "Condition", fill = "Condition") +
	scale_y_continuous(limits = c(0, 1), labels = scales::percent) +
	scale_colour_brewer(palette = "Set1") +
	scale_fill_brewer(palette = "Set1") +
	theme_bilingual() +
	theme(legend.title = element_blank(),
		  legend.position = "top",
		  panel.grid = element_line(colour = "grey", linetype = "dotted"))

```


#### Age group: 25 months


```{r gaze_time_vocab_25, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}

gaze_time_vocab_d %>% 
	filter(age_group == "25 months") %>% 
	ggplot(aes(x = time_bin, y = prop, colour = trial_type, fill = trial_type)) +
	facet_grid(lp~vocab_cat) +
	geom_hline(yintercept = 0.5, linetype = "dashed") +
	geom_smooth() +
	stat_summary(fun.data = mean_se, geom = "pointrange", size = 0.25) +
	#geom_line() +
	#geom_ribbon(aes(ymin = lower, ymax = upper), width = 0) 
	#geom_point(alpha = 0.5) +
	labs(x = "Time bin (100 ms)", y = "Fixations", colour = "Condition", fill = "Condition") +
	scale_y_continuous(limits = c(0, 1), labels = scales::percent) +
	scale_colour_brewer(palette = "Set1") +
	scale_fill_brewer(palette = "Set1") +
	theme_bilingual() +
	theme(legend.title = element_blank(),
		  legend.position = "top",
		  panel.grid = element_line(colour = "grey", linetype = "dotted"))

```

#### Age group: 30 months


```{r gaze_time_vocab_30, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}

gaze_time_vocab_d %>% 
	filter(age_group == "30 months") %>% 
	ggplot(aes(x = time_bin, y = prop, colour = trial_type, fill = trial_type)) +
	facet_grid(lp~vocab_cat) +
	geom_hline(yintercept = 0.5, linetype = "dashed") +
	geom_smooth() +
	stat_summary(fun.data = mean_se, geom = "pointrange", size = 0.25) +
	#geom_line() +
	#geom_ribbon(aes(ymin = lower, ymax = upper), width = 0) 
	#geom_point(alpha = 0.5) +
	labs(x = "Time bin (100 ms)", y = "Fixations", colour = "Condition", fill = "Condition") +
	scale_y_continuous(limits = c(0, 1), labels = scales::percent) +
	scale_colour_brewer(palette = "Set1") +
	scale_fill_brewer(palette = "Set1") +
	theme_bilingual() +
	theme(legend.title = element_blank(),
		  legend.position = "top",
		  panel.grid = element_line(colour = "grey", linetype = "dotted"))

```
### {-}

# Appendix

## Appendix 1: Individual attrition rates

```{r attrition_individual, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE, fig.height=12}

attrition %>%
	left_join(select(participants, location, lp, participant, date_test)) %>% 
	drop_na(trial_type) %>% 
	group_by(participant, lp, location, date_test, age_group, trial_type, valid_participant, valid_other) %>% 
	summarise(valid_trial_count = sum(valid_trial, na.rm = TRUE),
			  .groups = "drop") %>% 
	pivot_wider(names_from = trial_type, values_from = valid_trial_count) %>% 
	clean_names() %>% 
	mutate(
		participant = str_remove(participant, "cognatepriming"),
		cognate = paste0(cognate, " (", round(cognate/8, 2), "%)"),
		non_cognate = paste0(non_cognate, " (", round(non_cognate/8, 2), "%)"),
		unrelated = paste0(unrelated, " (", round(unrelated/8, 2), "%)"),
	) %>% 
	arrange(location, date_test) %>% 
	relocate(
		participant, location, date_test,
		age_group, lp, cognate, non_cognate,
		unrelated, valid_other, valid_participant) %>% 
	gt() %>% 
	gt::tab_spanner(
		"Valid trials (%) by trial type",
		c("cognate", "non_cognate", "unrelated")
	) %>% 
	cols_label(
		participant = "Participant",
		location = "Location",
		date_test = "Date",
		lp = "Group",
		age_group = "Age",
		valid_participant = "Valid trials",
		valid_other = "Valid (other)?",
		cognate = "Cognate",
		non_cognate = "Non-cognate",
		unrelated = "Unrelated"
	) %>% 
	tab_style(
		style = list(
			cell_fill(color = "#00FA9A")
		),
		locations = cells_body(
			columns = c("valid_participant"),
			rows = valid_participant
		)
	) %>% 
	tab_style(
		style = list(
			cell_fill(color = "#00FA9A")
		),
		locations = cells_body(
			columns = c("valid_other"),
			rows = valid_other
		)
	)

```


## Appendix 2: Individual target looking times

```{r gaze_time_participant, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE, fig.height=8}
gaze_time %>% 
	filter(valid_participant, valid_trial) %>% 
	group_by(participant, time_bin, trial_type, lp, age_group) %>% 
	summarise(
		prop = mean(prop, na.rm = TRUE),
		n = n(),
		.groups = "drop"
	) %>% 
	ungroup() %>% 
	mutate(
		se = sqrt((prop*(1-prop))/(n+4)),
		lower = prop-se,
		upper = prop+se
	) %>% 
	drop_na() %>% 
	ggplot(aes(x = time_bin, y = prop, colour = trial_type, fill = trial_type)) +
	facet_wrap(age_group~participant~lp) +
	geom_hline(yintercept = 0.5, linetype = "dashed") +
	geom_smooth() +
	#geom_ribbon(aes(ymin = lower, ymax = upper), width = 0) 
	# geom_point(shape = 1, stroke = 1, size = 0.5) +
	geom_text(aes(x = 0, y = 1, label =
				  	paste0(str_remove_all(participant, pattern = "[a-zA-Z]"),
				  		   "/", age_group, "mo/", lp)),
			  size = 2, colour = "black", hjust = 0) +
	labs(x = "Time bin (100 ms)", y = "Fixations", colour = "Condition", fill = "Condition") +
	scale_y_continuous(limits = c(0, 1), labels = scales::percent) +
	scale_colour_brewer(palette = "Set1") +
	scale_fill_brewer(palette = "Set1") +
	theme_bilingual() +
	theme(
		axis.text = element_text(size = 7),
		legend.title = element_blank(),
		legend.position = "top",
		strip.background = element_blank(),
		strip.text.x = element_blank()
	) +
	ggsave(here("Figures", "gaze_time_participant.png"), height = 12, width = 12)
```

# References

